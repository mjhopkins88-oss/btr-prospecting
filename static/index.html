<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BTR Prospecting Engine - AI-Powered Lead Intelligence</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>⚡</text></svg>">
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        orbitron: ['Orbitron', 'sans-serif'],
                        jetbrains: ['JetBrains Mono', 'monospace'],
                        inter: ['Inter', '-apple-system', 'BlinkMacSystemFont', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@500;700;900&family=JetBrains+Mono:wght@400;500;600&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #10b981;
            --primary-bright: #34d399;
            --primary-dim: #059669;
            --bg-dark: #0f172a;
            --bg-card: #1e293b;
            --bg-card-hover: #263548;
            --bg-surface: #0f172a;
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --text-muted: #64748b;
            --border: #334155;
            --border-subtle: #1e293b;
            --accent-red: #ef4444;
            --accent-blue: #3b82f6;
            --accent-cyan: #06b6d4;
            --accent-yellow: #f59e0b;
            --accent-purple: #a855f7;
            --accent-pink: #ec4899;
            --accent-teal: #14b8a6;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-dark);
            color: var(--text-primary);
            line-height: 1.6;
            overflow-x: hidden;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background:
                linear-gradient(90deg, rgba(16,185,129,0.015) 1px, transparent 1px),
                linear-gradient(rgba(16,185,129,0.015) 1px, transparent 1px);
            background-size: 60px 60px;
            pointer-events: none;
            z-index: 0;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }

        @keyframes glowPulse {
            0%, 100% { box-shadow: 0 0 12px rgba(16,185,129,0.5); }
            50% { box-shadow: 0 0 22px rgba(16,185,129,0.7); }
        }

        #root { position: relative; z-index: 1; }

        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: var(--bg-dark); }
        ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--text-muted); }

        .prospect-card {
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        .prospect-card:hover {
            transform: scale(1.01);
            box-shadow: 0 8px 30px rgba(0,0,0,0.2), 0 0 20px rgba(16,185,129,0.1);
        }
        .action-btn {
            transition: all 0.2s ease;
        }
        .action-btn:hover:not(:disabled) {
            border-color: #34d399 !important;
            color: #34d399 !important;
            background: rgba(16,185,129,0.05) !important;
        }
        .why-now-text {
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
            transition: all 0.3s ease;
        }
        .why-now-text.expanded {
            -webkit-line-clamp: unset;
            overflow: visible;
        }
        .filter-pill {
            transition: all 0.2s ease;
            cursor: pointer;
            user-select: none;
        }
        .filter-pill:hover {
            border-color: #34d399 !important;
            color: #6ee7b7 !important;
        }
        .btn-disabled {
            opacity: 0.6;
            cursor: not-allowed !important;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useCallback } = React;

        // Get API base URL (works both locally and on Railway)
        const API_BASE = window.location.hostname === 'localhost'
            ? 'http://localhost:5000'
            : window.location.origin;

        // Trigger pill color mapping
        function getTriggerStyle(trigger) {
            const t = trigger.toLowerCase();
            if (t.includes('capital') || t.includes('financing') || t.includes('institutional'))
                return { bg: 'rgba(168,85,247,0.15)', color: '#c4b5fd' };
            if (t.includes('builder') || t.includes('construction') || t.includes('property conversion'))
                return { bg: 'rgba(6,182,212,0.15)', color: '#67e8f9' };
            if (t.includes('expansion') || t.includes('state'))
                return { bg: 'rgba(20,184,166,0.15)', color: '#5eead4' };
            if (t.includes('refinance') || t.includes('debt'))
                return { bg: 'rgba(245,158,11,0.15)', color: '#fcd34d' };
            if (t.includes('jv') || t.includes('partner'))
                return { bg: 'rgba(236,72,153,0.15)', color: '#f9a8d4' };
            if (t.includes('lease'))
                return { bg: 'rgba(236,72,153,0.15)', color: '#f9a8d4' };
            if (t.includes('portfolio') || t.includes('blanket') || t.includes('scale'))
                return { bg: 'rgba(59,130,246,0.15)', color: '#93c5fd' };
            if (t.includes('lender') || t.includes('covenant'))
                return { bg: 'rgba(249,115,22,0.15)', color: '#fdba74' };
            return { bg: 'rgba(148,163,184,0.15)', color: '#94a3b8' };
        }

        // Generate stable prospect_key for CRM matching
        function makeProspectKey(company, website, city, state) {
            const normCompany = (company || '').toLowerCase().replace(/[^a-z0-9]/g, '');
            if (website) {
                const normDomain = (website || '').toLowerCase().replace(/^https?:\/\/(www\.)?/, '').replace(/\/$/, '');
                return normCompany + '|' + normDomain;
            }
            const normCity = (city || '').toLowerCase().replace(/[^a-z0-9]/g, '');
            const normState = (state || '').toLowerCase().replace(/[^a-z0-9]/g, '');
            return normCompany + '|' + normCity + '|' + normState;
        }

        // CRM status color mapping
        const CRM_STATUS_COLORS = {
            'New': { bg: 'rgba(99,102,241,0.15)', color: '#a5b4fc' },
            'Contacted': { bg: 'rgba(6,182,212,0.15)', color: '#67e8f9' },
            'InDiscussion': { bg: 'rgba(245,158,11,0.15)', color: '#fcd34d' },
            'Quoted': { bg: 'rgba(168,85,247,0.15)', color: '#c4b5fd' },
            'Won': { bg: 'rgba(16,185,129,0.15)', color: '#34d399' },
            'Lost': { bg: 'rgba(239,68,68,0.15)', color: '#f87171' },
            'Nurture': { bg: 'rgba(148,163,184,0.15)', color: '#94a3b8' },
        };
        const CRM_STATUSES = ['New', 'Contacted', 'InDiscussion', 'Quoted', 'Won', 'Lost', 'Nurture'];

        // ======= ROOT: Auth Gate =======
        function Root() {
            const [authState, setAuthState] = useState('loading'); // 'loading','bootstrap','login','authenticated'
            const [user, setUser] = useState(null);
            const [authError, setAuthError] = useState('');

            useEffect(() => { checkAuth(); }, []);

            const checkAuth = async () => {
                try {
                    const res = await fetch(`${API_BASE}/api/auth/me`);
                    const data = await res.json();
                    if (data.needs_bootstrap) { setAuthState('bootstrap'); }
                    else if (data.success && data.user) { setUser(data.user); setAuthState('authenticated'); }
                    else { setAuthState('login'); }
                } catch (e) { setAuthState('login'); }
            };

            const handleBootstrap = async (form) => {
                setAuthError('');
                try {
                    const res = await fetch(`${API_BASE}/api/auth/bootstrap`, {
                        method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(form)
                    });
                    const data = await res.json();
                    if (data.success) { setUser(data.user); setAuthState('authenticated'); }
                    else { setAuthError(data.message || 'Bootstrap failed'); }
                } catch (e) { setAuthError('Network error'); }
            };

            const handleLogin = async (email, password) => {
                setAuthError('');
                try {
                    const res = await fetch(`${API_BASE}/api/auth/login`, {
                        method: 'POST', headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ email, password })
                    });
                    const data = await res.json();
                    if (data.success) { setUser(data.user); setAuthState('authenticated'); }
                    else { setAuthError(data.message || 'Login failed'); }
                } catch (e) { setAuthError('Network error'); }
            };

            const handleLogout = async () => {
                await fetch(`${API_BASE}/api/auth/logout`, { method: 'POST' });
                setUser(null);
                setAuthState('login');
            };

            if (authState === 'loading') return (
                <div style={{minHeight:'100vh',display:'flex',alignItems:'center',justifyContent:'center'}}>
                    <div style={{fontFamily:"'Orbitron',sans-serif",color:'#34d399',fontSize:'1.2rem',animation:'pulse 1.5s ease-in-out infinite'}}>Loading...</div>
                </div>
            );
            if (authState === 'bootstrap') return <BootstrapPage onBootstrap={handleBootstrap} error={authError} />;
            if (authState === 'login') return <LoginPage onLogin={handleLogin} error={authError} />;
            return <App user={user} onLogout={handleLogout} />;
        }

        // ======= LOGIN PAGE =======
        function LoginPage({ onLogin, error }) {
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [submitting, setSubmitting] = useState(false);
            const handleSubmit = async (e) => {
                e.preventDefault();
                setSubmitting(true);
                await onLogin(email, password);
                setSubmitting(false);
            };
            return (
                <div style={{minHeight:'100vh',display:'flex',alignItems:'center',justifyContent:'center',padding:'2rem'}}>
                    <div style={{background:'#1e293b',border:'1px solid #334155',borderRadius:'16px',padding:'2.5rem',maxWidth:'400px',width:'100%'}}>
                        <h1 style={{fontFamily:"'Orbitron',sans-serif",fontSize:'1.5rem',fontWeight:900,
                            background:'linear-gradient(135deg,#34d399 0%,#22d3ee 100%)',WebkitBackgroundClip:'text',WebkitTextFillColor:'transparent',
                            marginBottom:'0.5rem',textAlign:'center'}}>BTR INTELLIGENCE</h1>
                        <p style={{color:'#64748b',textAlign:'center',marginBottom:'1.5rem',fontSize:'0.9rem'}}>Sign in to continue</p>
                        {error && <div style={{background:'rgba(239,68,68,0.1)',border:'1px solid rgba(239,68,68,0.3)',borderRadius:'8px',padding:'0.75rem',marginBottom:'1rem',color:'#f87171',fontSize:'0.85rem',textAlign:'center'}}>{error}</div>}
                        <form onSubmit={handleSubmit} style={{display:'flex',flexDirection:'column',gap:'0.85rem'}}>
                            <input type="email" required placeholder="Email" value={email} onChange={e=>setEmail(e.target.value)}
                                style={{...styles.input,width:'100%',minWidth:0}} />
                            <input type="password" required placeholder="Password" value={password} onChange={e=>setPassword(e.target.value)}
                                style={{...styles.input,width:'100%',minWidth:0}} />
                            <button type="submit" disabled={submitting}
                                style={{...styles.btnPrimary,width:'100%',padding:'0.75rem',fontSize:'1rem',...(submitting?{opacity:0.5}:{})}}>
                                {submitting ? 'Signing in...' : 'Sign In'}
                            </button>
                        </form>
                    </div>
                </div>
            );
        }

        // ======= BOOTSTRAP PAGE =======
        function BootstrapPage({ onBootstrap, error }) {
            const [form, setForm] = useState({ workspace_name: '', name: '', email: '', password: '' });
            const [submitting, setSubmitting] = useState(false);
            const update = (k, v) => setForm(f => ({...f, [k]: v}));
            const handleSubmit = async (e) => {
                e.preventDefault();
                setSubmitting(true);
                await onBootstrap(form);
                setSubmitting(false);
            };
            return (
                <div style={{minHeight:'100vh',display:'flex',alignItems:'center',justifyContent:'center',padding:'2rem'}}>
                    <div style={{background:'#1e293b',border:'1px solid #334155',borderRadius:'16px',padding:'2.5rem',maxWidth:'440px',width:'100%'}}>
                        <h1 style={{fontFamily:"'Orbitron',sans-serif",fontSize:'1.5rem',fontWeight:900,
                            background:'linear-gradient(135deg,#34d399 0%,#22d3ee 100%)',WebkitBackgroundClip:'text',WebkitTextFillColor:'transparent',
                            marginBottom:'0.5rem',textAlign:'center'}}>SETUP</h1>
                        <p style={{color:'#64748b',textAlign:'center',marginBottom:'1.5rem',fontSize:'0.9rem'}}>Create your workspace and admin account</p>
                        {error && <div style={{background:'rgba(239,68,68,0.1)',border:'1px solid rgba(239,68,68,0.3)',borderRadius:'8px',padding:'0.75rem',marginBottom:'1rem',color:'#f87171',fontSize:'0.85rem',textAlign:'center'}}>{error}</div>}
                        <form onSubmit={handleSubmit} style={{display:'flex',flexDirection:'column',gap:'0.85rem'}}>
                            <input required placeholder="Workspace Name (e.g., BTR Agency)" value={form.workspace_name} onChange={e=>update('workspace_name',e.target.value)}
                                style={{...styles.input,width:'100%',minWidth:0}} />
                            <input required placeholder="Your Name" value={form.name} onChange={e=>update('name',e.target.value)}
                                style={{...styles.input,width:'100%',minWidth:0}} />
                            <input type="email" required placeholder="Email" value={form.email} onChange={e=>update('email',e.target.value)}
                                style={{...styles.input,width:'100%',minWidth:0}} />
                            <input type="password" required placeholder="Password (8+ chars)" value={form.password} onChange={e=>update('password',e.target.value)}
                                style={{...styles.input,width:'100%',minWidth:0}} />
                            <button type="submit" disabled={submitting}
                                style={{...styles.btnPrimary,width:'100%',padding:'0.75rem',fontSize:'1rem',...(submitting?{opacity:0.5}:{})}}>
                                {submitting ? 'Creating...' : 'Create Workspace'}
                            </button>
                        </form>
                    </div>
                </div>
            );
        }

        // ======= MAIN APP =======
        function App({ user, onLogout }) {
            const [activeTab, setActiveTab] = useState('search');
            const [prospects, setProspects] = useState([]);
            const [loading, setLoading] = useState(false);
            const [selectedProspect, setSelectedProspect] = useState(null);
            const [searchCity, setSearchCity] = useState('Texas');
            const [filterScore, setFilterScore] = useState('all');
            const [emailTemplate, setEmailTemplate] = useState({ subject: '', body: '' });
            const [showEmailModal, setShowEmailModal] = useState(false);
            const [searchStatus, setSearchStatus] = useState('');
            const [cooldown, setCooldown] = useState(0);
            // CRM state
            const [crmStatuses, setCrmStatuses] = useState({});
            const [touchpointTarget, setTouchpointTarget] = useState(null); // {lead_id, company_name}

            useEffect(() => { loadProspects(); }, []);

            useEffect(() => {
                if (cooldown <= 0) return;
                const timer = setTimeout(() => setCooldown(cooldown - 1), 1000);
                return () => clearTimeout(timer);
            }, [cooldown]);

            // Fetch CRM statuses for all visible prospects
            const loadCrmStatuses = useCallback(async (prospectsList) => {
                if (!user || !prospectsList || prospectsList.length === 0) return;
                const keys = prospectsList.map(p => makeProspectKey(p.company, null, p.city, p.state));
                const uniqueKeys = [...new Set(keys)].slice(0, 200);
                if (uniqueKeys.length === 0) return;
                try {
                    const res = await fetch(`${API_BASE}/api/crm/leads/bulk-status?keys=${encodeURIComponent(uniqueKeys.join(','))}`);
                    const data = await res.json();
                    if (data.success) setCrmStatuses(data.statuses || {});
                } catch (e) { console.error('CRM bulk status error:', e); }
            }, [user]);

            const loadProspects = async () => {
                try {
                    const response = await fetch(`${API_BASE}/api/prospects`);
                    const data = await response.json();
                    if (data.success) {
                        setProspects(data.prospects);
                        loadCrmStatuses(data.prospects);
                    }
                } catch (error) { console.error('Error loading prospects:', error); }
            };

            const pollRef = useRef(null);
            useEffect(() => {
                return () => { if (pollRef.current) clearInterval(pollRef.current); };
            }, []);

            const searchProspects = async () => {
                if (cooldown > 0) return;
                setLoading(true);
                setSearchStatus('Starting prospecting run...');
                setCooldown(30);
                try {
                    const response = await fetch(`${API_BASE}/api/prospecting/run`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            cities: [{ city: searchCity, state: '' }],
                            maxProspectsPerCity: 25,
                            maxTotalProspects: 300
                        })
                    });
                    const data = await response.json();
                    if (!data.success) {
                        setSearchStatus(`Error: ${data.message}`);
                        setLoading(false);
                        setTimeout(() => setSearchStatus(''), 5000);
                        return;
                    }
                    const runId = data.run_id;
                    setSearchStatus('AI is searching CRE sources for BTR prospects...');
                    if (pollRef.current) clearInterval(pollRef.current);
                    pollRef.current = setInterval(async () => {
                        try {
                            const statusRes = await fetch(`${API_BASE}/api/prospecting/run/${runId}/status`);
                            const statusData = await statusRes.json();
                            if (statusData.total_prospects > 0) {
                                setSearchStatus(`Found ${statusData.total_prospects} prospects so far...`);
                            }
                            if (statusData.status === 'completed') {
                                clearInterval(pollRef.current);
                                pollRef.current = null;
                                setSearchStatus(`Found ${statusData.total_prospects} prospects!`);
                                await loadProspects();
                                setLoading(false);
                                setTimeout(() => setSearchStatus(''), 5000);
                            } else if (statusData.status === 'failed') {
                                clearInterval(pollRef.current);
                                pollRef.current = null;
                                setSearchStatus(`Search failed: ${statusData.error || 'Unknown error'}`);
                                setLoading(false);
                                setTimeout(() => setSearchStatus(''), 8000);
                            }
                        } catch (e) { console.error('Poll error:', e); }
                    }, 3000);
                } catch (error) {
                    console.error('Search error:', error);
                    setSearchStatus('Failed to start search. Check your connection.');
                    setLoading(false);
                    setTimeout(() => setSearchStatus(''), 5000);
                }
            };

            const generateEmail = async (prospect, options = {}) => {
                setLoading(true);
                setSearchStatus('AI is writing a personalized email...');
                const controller = new AbortController();
                const timeout = setTimeout(() => controller.abort(), 30000);
                try {
                    const response = await fetch(`${API_BASE}/api/email/generate`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            prospect: prospect,
                            emailPurpose: options.emailPurpose || 'cold_outreach',
                            tone: options.tone || 'professional_direct',
                            offer: options.offer || '15_min_call',
                            triggerEvent: options.triggerEvent || ''
                        }),
                        signal: controller.signal
                    });
                    clearTimeout(timeout);
                    const text = await response.text();
                    let data;
                    try { data = JSON.parse(text); }
                    catch (e) {
                        console.error('Email response not JSON:', text.substring(0, 200));
                        setSearchStatus('Email generation returned an invalid response. Try again.');
                        setTimeout(() => setSearchStatus(''), 5000);
                        return;
                    }
                    if (data.success) {
                        const subject = data.subject || '';
                        const body = data.body || data.email || 'No email body returned. Try again.';
                        setSelectedProspect(prospect);
                        setEmailTemplate({ subject, body });
                        setShowEmailModal(true);
                        setSearchStatus('');
                    } else {
                        setSearchStatus(`${data.message || 'Email generation failed.'}`);
                        setTimeout(() => setSearchStatus(''), 5000);
                    }
                } catch (error) {
                    clearTimeout(timeout);
                    console.error('Email generation error:', error);
                    if (error.name === 'AbortError') {
                        setSearchStatus('Email generation timed out. Try again.');
                    } else {
                        setSearchStatus(`Email generation failed: ${error.message}`);
                    }
                    setTimeout(() => setSearchStatus(''), 5000);
                } finally { setLoading(false); }
            };

            const exportToCSV = async () => {
                try {
                    const response = await fetch(`${API_BASE}/api/export`);
                    if (response.ok) {
                        const blob = await response.blob();
                        const url = URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = `btr-prospects-master-${new Date().toISOString().split('T')[0]}.csv`;
                        a.click();
                        URL.revokeObjectURL(url);
                        setSearchStatus(`Master spreadsheet downloaded (${prospects.length} prospects)`);
                        setTimeout(() => setSearchStatus(''), 3000);
                    } else {
                        const data = await response.json();
                        setSearchStatus(`${data.message || 'Export failed'}`);
                        setTimeout(() => setSearchStatus(''), 5000);
                    }
                } catch (error) {
                    console.error('Export error:', error);
                    setSearchStatus('Export failed. Try again.');
                    setTimeout(() => setSearchStatus(''), 5000);
                }
            };

            const deleteProspect = async (prospectId) => {
                if (!confirm('Delete this prospect?')) return;
                try {
                    await fetch(`${API_BASE}/api/prospects/${prospectId}`, { method: 'DELETE' });
                    await loadProspects();
                } catch (error) { console.error('Delete error:', error); }
            };

            const [filterTrigger, setFilterTrigger] = useState('all');
            const [filterSwimLane, setFilterSwimLane] = useState(false);
            const [sortBy, setSortBy] = useState('score');
            const [filterEightyPlus, setFilterEightyPlus] = useState(false);
            const [filterCapitalEvents, setFilterCapitalEvents] = useState(false);
            const [filterLowComp, setFilterLowComp] = useState(false);

            const filteredProspects = prospects.filter(p => {
                if (searchCity !== 'all' && searchCity !== 'Texas' && !p.city?.toLowerCase().includes(searchCity.toLowerCase())) return false;
                if (filterScore === '90+' && p.score < 90) return false;
                if (filterScore === '80+' && p.score < 80) return false;
                if (filterScore === '80-89' && (p.score < 80 || p.score >= 90)) return false;
                if (filterEightyPlus && p.score < 80) return false;
                if (filterTrigger !== 'all') {
                    const triggers = p.insurance_triggers || [];
                    if (!triggers.some(t => t.toLowerCase().includes(filterTrigger.toLowerCase()))) return false;
                }
                if (filterCapitalEvents) {
                    const triggers = p.insurance_triggers || [];
                    if (!triggers.some(t => t.toLowerCase().includes('capital') || t.toLowerCase().includes('jv'))) return false;
                }
                if (filterSwimLane) {
                    const band = p.unit_band || '';
                    if (band !== '40-150' && band !== '150-400') return false;
                }
                if (filterLowComp) {
                    if ((p.competitive_difficulty || '') !== 'Low') return false;
                }
                return true;
            }).sort((a, b) => {
                if (sortBy === 'swim_lane') return (b.swim_lane_fit_score || 0) - (a.swim_lane_fit_score || 0);
                return (b.score || 0) - (a.score || 0);
            });

            const saveToPipeline = async (prospect) => {
                const pk = makeProspectKey(prospect.company, null, prospect.city, prospect.state);
                try {
                    const res = await fetch(`${API_BASE}/api/crm/lead/upsert`, {
                        method: 'POST', headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ prospect_key: pk, company_name: prospect.company })
                    });
                    const data = await res.json();
                    if (data.success) {
                        setCrmStatuses(prev => ({...prev, [pk]: { lead_id: data.lead.id, status: data.lead.status, owner_user_id: data.lead.owner_user_id }}));
                    }
                } catch (e) { console.error('Save to pipeline error:', e); }
            };

            const openTouchpoint = (leadId, companyName) => {
                setTouchpointTarget({ lead_id: leadId, company_name: companyName });
            };

            return (
                <div style={styles.container}>
                    <Header user={user} onLogout={onLogout} />
                    <TabBar activeTab={activeTab} setActiveTab={setActiveTab} user={user} />
                    {activeTab === 'search' && (
                        <React.Fragment>
                            <Stats prospects={prospects} />
                            <Controls
                                searchCity={searchCity}
                                setSearchCity={setSearchCity}
                                filterScore={filterScore}
                                setFilterScore={setFilterScore}
                                filterTrigger={filterTrigger}
                                setFilterTrigger={setFilterTrigger}
                                filterSwimLane={filterSwimLane}
                                setFilterSwimLane={setFilterSwimLane}
                                sortBy={sortBy}
                                setSortBy={setSortBy}
                                onSearch={searchProspects}
                                onExport={exportToCSV}
                                loading={loading}
                                hasProspects={prospects.length > 0}
                                cooldown={cooldown}
                                filterEightyPlus={filterEightyPlus}
                                setFilterEightyPlus={setFilterEightyPlus}
                                filterCapitalEvents={filterCapitalEvents}
                                setFilterCapitalEvents={setFilterCapitalEvents}
                                filterLowComp={filterLowComp}
                                setFilterLowComp={setFilterLowComp}
                            />
                            {searchStatus && <SearchStatus message={searchStatus} />}
                            {loading && <Loading />}
                            <ProspectsList
                                prospects={filteredProspects}
                                onGenerateEmail={generateEmail}
                                onDelete={deleteProspect}
                                crmStatuses={crmStatuses}
                                onSaveToPipeline={saveToPipeline}
                                onLogTouchpoint={openTouchpoint}
                                user={user}
                            />
                        </React.Fragment>
                    )}
                    {activeTab === 'discovery' && <DailyDiscovery />}
                    {activeTab === 'pipeline' && <PipelinePage user={user} />}
                    {activeTab === 'followups' && <FollowUpsPage user={user} />}
                    {activeTab === 'statewide' && <StatewideDiscovery />}
                    {showEmailModal && (
                        <EmailModal
                            email={emailTemplate}
                            prospect={selectedProspect}
                            onClose={() => setShowEmailModal(false)}
                        />
                    )}
                    {touchpointTarget && (
                        <TouchpointModal
                            target={touchpointTarget}
                            onClose={() => setTouchpointTarget(null)}
                            onSaved={() => { loadCrmStatuses(prospects); }}
                        />
                    )}
                </div>
            );
        }

        function Header({ user, onLogout }) {
            return (
                <div style={{...styles.header, display:'flex', justifyContent:'space-between', alignItems:'center', textAlign:'left'}}>
                    <div>
                        <h1 style={{...styles.title, fontSize:'1.8rem'}}>BTR INTELLIGENCE TERMINAL</h1>
                        <p style={styles.subtitle}>AI-Powered Lead Intelligence System</p>
                    </div>
                    {user && (
                        <div style={{display:'flex',alignItems:'center',gap:'0.75rem',flexShrink:0}}>
                            <span style={{fontSize:'0.85rem',color:'#94a3b8'}}>{user.name}</span>
                            <span style={{fontSize:'0.65rem',padding:'0.15rem 0.5rem',borderRadius:'4px',
                                background: user.role==='admin' ? 'rgba(168,85,247,0.15)' : 'rgba(6,182,212,0.15)',
                                color: user.role==='admin' ? '#c4b5fd' : '#67e8f9',
                                textTransform:'uppercase',fontWeight:600}}>{user.role}</span>
                            <button className="action-btn" style={{...styles.actionBtn,fontSize:'0.75rem'}} onClick={onLogout}>Logout</button>
                        </div>
                    )}
                </div>
            );
        }

        function TabBar({ activeTab, setActiveTab, user }) {
            const tabs = [
                { id: 'search', label: 'Prospect Search' },
                { id: 'discovery', label: 'Daily Discovery' },
                { id: 'statewide', label: 'Statewide' },
                { id: 'pipeline', label: 'My Pipeline' },
                { id: 'followups', label: 'Follow-ups Due' },
            ];
            return (
                <div style={ds.tabBar}>
                    {tabs.map(tab => (
                        <button
                            key={tab.id}
                            style={{
                                ...ds.tab,
                                ...(activeTab === tab.id ? ds.tabActive : {})
                            }}
                            onClick={() => setActiveTab(tab.id)}
                        >
                            {tab.label}
                        </button>
                    ))}
                </div>
            );
        }

        function Stats({ prospects }) {
            const avgScore = prospects.length > 0
                ? Math.round(prospects.reduce((sum, p) => sum + p.score, 0) / prospects.length)
                : 0;
            const hotLeads = prospects.filter(p => p.score >= 90).length;
            const hasData = prospects.length > 0;
            return (
                <div style={styles.statsBar}>
                    <StatCard label="Total Prospects" value={hasData ? prospects.length : '--'} />
                    <StatCard label="Hot Leads (90+)" value={hasData ? hotLeads : '--'} pulse={hasData && hotLeads > 0} />
                    <StatCard label="Avg Score" value={hasData ? avgScore : '--'} />
                    <StatCard label="Status" value="LIVE" />
                </div>
            );
        }

        function StatCard({ label, value, pulse }) {
            return (
                <div style={styles.statCard}>
                    <div style={styles.statLabel}>{label}</div>
                    <div style={{...styles.statValue, ...(pulse ? styles.pulse : {})}}>{String(value)}</div>
                </div>
            );
        }

        function Controls({ searchCity, setSearchCity, filterScore, setFilterScore, filterTrigger, setFilterTrigger, filterSwimLane, setFilterSwimLane, sortBy, setSortBy, onSearch, onExport, loading, hasProspects, cooldown, filterEightyPlus, setFilterEightyPlus, filterCapitalEvents, setFilterCapitalEvents, filterLowComp, setFilterLowComp }) {
            const isDisabled = loading || cooldown > 0;
            let btnLabel = 'Search Prospects';
            if (loading) btnLabel = 'Searching...';
            else if (cooldown > 0) btnLabel = `Wait ${cooldown}s`;

            const pillStyle = (active) => ({
                fontSize: '0.8rem',
                padding: '0.4rem 0.85rem',
                borderRadius: '9999px',
                border: `1px solid ${active ? '#34d399' : '#334155'}`,
                background: active ? 'rgba(16,185,129,0.15)' : 'transparent',
                color: active ? '#34d399' : '#94a3b8',
                cursor: 'pointer',
                fontFamily: 'Inter, sans-serif',
                fontWeight: 500,
            });

            return (
                <div style={styles.controls}>
                    <div style={{display: 'flex', gap: '0.75rem', flexWrap: 'wrap', alignItems: 'center', width: '100%'}}>
                        <button
                            style={{...styles.btnPrimary, ...(isDisabled ? {opacity: 0.5, cursor: 'not-allowed'} : {})}}
                            onClick={onSearch}
                            disabled={isDisabled}
                        >
                            {btnLabel}
                        </button>
                        <input
                            type="text"
                            style={styles.input}
                            value={searchCity}
                            onChange={(e) => setSearchCity(e.target.value)}
                            placeholder="City or State (e.g., Dallas, Texas)"
                        />
                        <select style={styles.select} value={filterScore} onChange={(e) => setFilterScore(e.target.value)}>
                            <option value="all">All Scores</option>
                            <option value="90+">90+ (Urgent)</option>
                            <option value="80+">80+ (High Priority)</option>
                            <option value="80-89">80-89 (High)</option>
                        </select>
                        <select style={styles.select} value={filterTrigger} onChange={(e) => setFilterTrigger(e.target.value)}>
                            <option value="all">All Triggers</option>
                            <option value="Builder's Risk">Builder's Risk</option>
                            <option value="lender covenants">Lender Covenants</option>
                            <option value="Portfolio scale">Portfolio Scale</option>
                            <option value="state expansion">State Expansion</option>
                            <option value="capital event">Capital Event</option>
                            <option value="Refinance">Refinance / Debt</option>
                            <option value="Lease-up">Lease-up Shift</option>
                        </select>
                        <select style={styles.select} value={sortBy} onChange={(e) => setSortBy(e.target.value)}>
                            <option value="score">Sort: Severity Score</option>
                            <option value="swim_lane">Sort: Swim Lane Fit</option>
                        </select>
                        {hasProspects && (
                            <button className="action-btn" style={styles.btn} onClick={onExport}>
                                Download CSV
                            </button>
                        )}
                    </div>
                    <div style={{display: 'flex', gap: '0.5rem', flexWrap: 'wrap', alignItems: 'center', paddingTop: '0.65rem', borderTop: '1px solid #1e293b', width: '100%'}}>
                        <span style={{fontSize: '0.75rem', color: '#64748b', marginRight: '0.25rem', textTransform: 'uppercase', fontWeight: 600, letterSpacing: '0.05em'}}>Quick Filters</span>
                        <button className="filter-pill" style={pillStyle(filterEightyPlus)} onClick={() => setFilterEightyPlus(!filterEightyPlus)}>
                            {filterEightyPlus ? '✓ ' : ''}80+ Only
                        </button>
                        <button className="filter-pill" style={pillStyle(filterSwimLane)} onClick={() => setFilterSwimLane(!filterSwimLane)}>
                            {filterSwimLane ? '✓ ' : ''}40-400 Units
                        </button>
                        <button className="filter-pill" style={pillStyle(filterCapitalEvents)} onClick={() => setFilterCapitalEvents(!filterCapitalEvents)}>
                            {filterCapitalEvents ? '✓ ' : ''}Capital Events
                        </button>
                        <button className="filter-pill" style={pillStyle(filterLowComp)} onClick={() => setFilterLowComp(!filterLowComp)}>
                            {filterLowComp ? '✓ ' : ''}Low Competition
                        </button>
                    </div>
                </div>
            );
        }

        function SearchStatus({ message }) {
            return (
                <div style={styles.searchStatus}>
                    <p>{message}</p>
                </div>
            );
        }

        function Loading() {
            return (
                <div style={styles.loading}>
                    <div style={styles.loadingText}>Processing...</div>
                </div>
            );
        }

        function ProspectsList({ prospects, onGenerateEmail, onDelete, crmStatuses, onSaveToPipeline, onLogTouchpoint, user }) {
            if (prospects.length === 0) {
                return (
                    <div style={styles.empty}>
                        <h2 style={styles.emptyTitle}>No prospects yet</h2>
                        <p style={styles.emptyText}>Click "Search Prospects" to find BTR developers using AI</p>
                        <p style={styles.emptySubtext}>The AI will search the web for active BTR developers, executives, and project details</p>
                    </div>
                );
            }
            return (
                <div style={styles.grid}>
                    {prospects.map((prospect) => {
                        const pk = makeProspectKey(prospect.company, null, prospect.city, prospect.state);
                        const crmInfo = (crmStatuses || {})[pk];
                        return (
                            <ProspectCard
                                key={prospect.id}
                                prospect={prospect}
                                onGenerateEmail={onGenerateEmail}
                                onDelete={onDelete}
                                crmInfo={crmInfo}
                                onSaveToPipeline={onSaveToPipeline}
                                onLogTouchpoint={onLogTouchpoint}
                                user={user}
                            />
                        );
                    })}
                </div>
            );
        }

        function ScoreBar({ label, value, max, color }) {
            const pct = max > 0 ? Math.round((value / max) * 100) : 0;
            return (
                <div style={{display: 'flex', alignItems: 'center', gap: '0.5rem', marginBottom: '0.3rem'}}>
                    <span style={{fontSize: '0.7rem', color: '#64748b', width: '90px', textAlign: 'right', flexShrink: 0}}>{label}</span>
                    <div style={{flex: 1, height: '5px', background: '#1e293b', borderRadius: '3px', overflow: 'hidden'}}>
                        <div style={{width: `${pct}%`, height: '100%', background: color, borderRadius: '3px', transition: 'width 0.3s'}} />
                    </div>
                    <span style={{fontSize: '0.7rem', color: color, width: '30px', flexShrink: 0}}>{value}/{max}</span>
                </div>
            );
        }

        function ProspectCard({ prospect, onGenerateEmail, onDelete, crmInfo, onSaveToPipeline, onLogTouchpoint, user }) {
            const [showEmailOptions, setShowEmailOptions] = useState(false);
            const [whyNowExpanded, setWhyNowExpanded] = useState(false);
            const [emailPurpose, setEmailPurpose] = useState('cold_outreach');
            const [tone, setTone] = useState('professional_direct');
            const [offer, setOffer] = useState('15_min_call');

            const foundDate = prospect.createdAt
                ? new Date(prospect.createdAt).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })
                : null;

            const handleGenerate = () => {
                onGenerateEmail(prospect, { emailPurpose, tone, offer });
                setShowEmailOptions(false);
            };

            const score = prospect.score || 0;
            const breakdown = prospect.score_breakdown || {};
            const hasBreakdown = Object.keys(breakdown).length > 0;
            const explanation = prospect.score_explanation || [];
            const triggers = prospect.insurance_triggers || [];
            const swimLane = prospect.swim_lane_fit_score || 0;
            const unitBand = prospect.unit_band || '';
            const competitiveDifficulty = prospect.competitive_difficulty || '';

            // Score badge border + glow
            let scoreBorderColor = '#475569';
            let scoreGlow = 'none';
            let scoreAnim = 'none';
            if (score >= 90) { scoreBorderColor = '#6ee7b7'; scoreGlow = '0 0 14px rgba(16,185,129,0.45)'; scoreAnim = 'glowPulse 2s ease-in-out infinite'; }
            else if (score >= 80) { scoreBorderColor = '#10b981'; scoreGlow = '0 0 10px rgba(16,185,129,0.25)'; }
            else if (score >= 70) { scoreBorderColor = '#3b82f6'; }

            // Card left accent
            let cardAccent = {};
            if (score >= 85) cardAccent = { borderLeft: '4px solid #34d399' };
            else if (score >= 70) cardAccent = { borderLeft: '4px solid #3b82f6' };

            // Competitive difficulty dot
            const compDotColor = competitiveDifficulty === 'Low' ? '#34d399' : competitiveDifficulty === 'Medium' ? '#fbbf24' : '#ef4444';

            return (
                <div className="prospect-card" style={{...styles.card, ...cardAccent}}>
                    {/* Header: Company + Score */}
                    <div style={styles.cardHeader}>
                        <div style={{flex: 1, minWidth: 0}}>
                            <div style={{display:'flex',alignItems:'center',gap:'0.5rem',flexWrap:'wrap'}}>
                                <h3 style={{...styles.companyName,marginBottom:0}}>{prospect.company}</h3>
                                {crmInfo && (
                                    <span style={{fontSize:'0.65rem',padding:'0.15rem 0.45rem',borderRadius:'4px',fontWeight:600,
                                        background:(CRM_STATUS_COLORS[crmInfo.status]||CRM_STATUS_COLORS.New).bg,
                                        color:(CRM_STATUS_COLORS[crmInfo.status]||CRM_STATUS_COLORS.New).color,
                                        textTransform:'uppercase',letterSpacing:'0.03em'}}>{crmInfo.status}</span>
                                )}
                                {crmInfo && crmInfo.owner_name && (
                                    <span style={{fontSize:'0.65rem',color:'#64748b'}}>{crmInfo.owner_name}</span>
                                )}
                            </div>
                            <p style={styles.location}>{prospect.city}, {prospect.state}{foundDate ? ` · ${foundDate}` : ''}</p>
                        </div>
                        <div style={{display: 'flex', gap: '0.6rem', alignItems: 'center', flexShrink: 0}}>
                            {swimLane > 0 && (
                                <div style={{
                                    fontSize: '0.75rem',
                                    padding: '0.25rem 0.55rem',
                                    borderRadius: '6px',
                                    background: 'rgba(99,102,241,0.15)',
                                    color: '#a5b4fc',
                                    fontWeight: 500,
                                    letterSpacing: '0.02em',
                                }}>
                                    Swim Fit {swimLane}
                                </div>
                            )}
                            <div style={{
                                width: '3.5rem', height: '3.5rem',
                                borderRadius: '50%',
                                display: 'flex', alignItems: 'center', justifyContent: 'center',
                                border: `2px solid ${scoreBorderColor}`,
                                boxShadow: scoreGlow,
                                animation: scoreAnim,
                                fontFamily: "'Orbitron', sans-serif",
                                fontWeight: 700,
                                fontSize: '1.1rem',
                                color: '#fff',
                                flexShrink: 0,
                            }}>
                                {score}
                            </div>
                        </div>
                    </div>

                    {/* Executive */}
                    <div style={styles.executive}>
                        <strong>{prospect.executive || 'Contact via company'}</strong> {prospect.title && `- ${prospect.title}`}
                        {prospect.linkedin && (
                            <a href={`https://${prospect.linkedin}`} target="_blank" style={styles.linkedinLink}>
                                LinkedIn
                            </a>
                        )}
                    </div>

                    {/* Score Breakdown */}
                    {hasBreakdown && (
                        <div style={{padding: '0.75rem', background: '#0b1220', borderRadius: '8px', border: '1px solid #1e293b'}}>
                            <div style={{fontSize: '0.7rem', color: '#64748b', fontWeight: 600, marginBottom: '0.5rem', textTransform: 'uppercase', letterSpacing: '0.05em'}}>Trigger Severity</div>
                            <ScoreBar label="Capital Event" value={breakdown.capital_event || 0} max={40} color="#ef4444" />
                            <ScoreBar label="Construction" value={breakdown.construction_stage || 0} max={25} color="#06b6d4" />
                            <ScoreBar label="Expansion" value={breakdown.expansion_velocity || 0} max={20} color="#f59e0b" />
                            <ScoreBar label="Freshness" value={breakdown.freshness || 0} max={15} color="#10b981" />
                        </div>
                    )}

                    {/* Score Explanation */}
                    {explanation.length > 0 && (
                        <div style={{padding: '0.5rem 0.75rem', background: 'rgba(6,182,212,0.05)', borderLeft: '2px solid #06b6d4', borderRadius: '0 6px 6px 0'}}>
                            <div style={{fontSize: '0.65rem', color: '#06b6d4', fontWeight: 600, marginBottom: '0.3rem', textTransform: 'uppercase', letterSpacing: '0.05em'}}>Score Rationale</div>
                            {explanation.map((line, idx) => (
                                <div key={idx} style={{fontSize: '0.78rem', color: '#94a3b8', lineHeight: '1.4', marginBottom: '0.15rem'}}>• {line}</div>
                            ))}
                        </div>
                    )}

                    {/* Insurance Trigger Pills */}
                    {triggers.length > 0 && (
                        <div>
                            <div style={{fontSize: '0.65rem', color: '#64748b', fontWeight: 600, marginBottom: '0.4rem', textTransform: 'uppercase', letterSpacing: '0.05em'}}>Insurance Triggers</div>
                            <div style={{display: 'flex', flexWrap: 'wrap', gap: '0.4rem'}}>
                                {triggers.map((trigger, idx) => {
                                    const ts = getTriggerStyle(trigger);
                                    return (
                                        <span key={idx} style={{
                                            fontSize: '0.75rem',
                                            padding: '0.25rem 0.7rem',
                                            borderRadius: '9999px',
                                            background: ts.bg,
                                            color: ts.color,
                                            fontWeight: 500,
                                            whiteSpace: 'nowrap',
                                        }}>{trigger}</span>
                                    );
                                })}
                            </div>
                        </div>
                    )}

                    {/* Swim Lane + Competitive Difficulty */}
                    {(unitBand || competitiveDifficulty) && (
                        <div style={{display: 'flex', gap: '0.75rem', flexWrap: 'wrap', alignItems: 'center'}}>
                            {unitBand && (
                                <span style={{
                                    fontSize: '0.75rem',
                                    padding: '0.2rem 0.6rem',
                                    borderRadius: '6px',
                                    background: 'rgba(6,182,212,0.1)',
                                    color: '#67e8f9',
                                    border: '1px solid rgba(6,182,212,0.25)',
                                }}>{unitBand} units</span>
                            )}
                            {competitiveDifficulty && (
                                <div style={{display: 'flex', alignItems: 'center', gap: '0.35rem'}}>
                                    <span style={{
                                        width: '0.5rem', height: '0.5rem',
                                        borderRadius: '50%',
                                        background: compDotColor,
                                        display: 'inline-block',
                                    }} />
                                    <span style={{fontSize: '0.75rem', color: '#94a3b8'}}>
                                        {competitiveDifficulty} Competition
                                    </span>
                                </div>
                            )}
                        </div>
                    )}

                    {/* Project Details */}
                    <div style={styles.details}>
                        <div><span style={{color: '#64748b'}}>Project:</span> {prospect.projectName}</div>
                        <div><span style={{color: '#64748b'}}>Status:</span> {prospect.projectStatus}</div>
                        <div><span style={{color: '#64748b'}}>Size:</span> {prospect.units}</div>
                        <div><span style={{color: '#64748b'}}>TIV:</span> {prospect.tiv}</div>
                    </div>

                    {/* Why Call Now */}
                    {prospect.whyNow && (
                        <div style={styles.whyNow}>
                            <div style={{fontSize: '0.7rem', color: '#ef4444', fontWeight: 600, marginBottom: '0.3rem', textTransform: 'uppercase', letterSpacing: '0.05em'}}>Why Call Now</div>
                            <p className={`why-now-text${whyNowExpanded ? ' expanded' : ''}`} style={{color: '#cbd5e1', fontSize: '0.875rem', margin: 0, lineHeight: '1.5'}}>{prospect.whyNow}</p>
                            <span
                                onClick={() => setWhyNowExpanded(!whyNowExpanded)}
                                style={{fontSize: '0.75rem', color: '#ef4444', cursor: 'pointer', marginTop: '0.25rem', display: 'inline-block', opacity: 0.8}}
                            >
                                {whyNowExpanded ? 'Collapse' : 'Expand'}
                            </span>
                        </div>
                    )}

                    {/* Signals */}
                    {prospect.signals && prospect.signals.length > 0 && (
                        <div style={styles.signals}>
                            <div style={{fontSize: '0.7rem', color: '#06b6d4', fontWeight: 600, marginBottom: '0.3rem', textTransform: 'uppercase', letterSpacing: '0.05em'}}>Signals</div>
                            <ul style={styles.signalList}>
                                {prospect.signals.map((signal, idx) => (
                                    <li key={idx} style={styles.signalItem}>&#9656; {signal}</li>
                                ))}
                            </ul>
                        </div>
                    )}

                    {/* Email Options */}
                    {showEmailOptions && (
                        <div style={styles.emailOptions}>
                            <div style={styles.emailOptionRow}>
                                <label style={styles.emailOptionLabel}>Purpose</label>
                                <select style={styles.select} value={emailPurpose} onChange={e => setEmailPurpose(e.target.value)}>
                                    <option value="cold_outreach">Cold Outreach</option>
                                    <option value="follow_up">Follow Up</option>
                                    <option value="event_invite">Event Invite</option>
                                    <option value="post_event_follow_up">Post-Event Follow Up</option>
                                    <option value="referral_intro">Referral Intro</option>
                                    <option value="renewal_quote_follow_up">Renewal/Quote Follow Up</option>
                                </select>
                            </div>
                            <div style={styles.emailOptionRow}>
                                <label style={styles.emailOptionLabel}>Tone</label>
                                <select style={styles.select} value={tone} onChange={e => setTone(e.target.value)}>
                                    <option value="professional_direct">Professional Direct</option>
                                    <option value="strategic_exec">Strategic Exec</option>
                                    <option value="conversational">Conversational</option>
                                    <option value="friendly">Friendly</option>
                                    <option value="urgent_light">Urgent (Light)</option>
                                </select>
                            </div>
                            <div style={styles.emailOptionRow}>
                                <label style={styles.emailOptionLabel}>CTA / Offer</label>
                                <select style={styles.select} value={offer} onChange={e => setOffer(e.target.value)}>
                                    <option value="15_min_call">15-Min Call</option>
                                    <option value="share_resource">Share a Resource</option>
                                    <option value="quick_question">Quick Question</option>
                                </select>
                            </div>
                            <button className="action-btn" style={{...styles.btnPrimary, fontSize: '0.85rem'}} onClick={handleGenerate}>
                                Generate Now
                            </button>
                        </div>
                    )}

                    {/* Action Buttons */}
                    <div style={{...styles.cardActions, justifyContent: 'flex-end'}}>
                        {!crmInfo ? (
                            <button className="action-btn" style={{...styles.actionBtn,borderColor:'#10b981',color:'#34d399'}} onClick={() => onSaveToPipeline(prospect)}>
                                Save to Pipeline
                            </button>
                        ) : (
                            <button className="action-btn" style={styles.actionBtn} onClick={() => onLogTouchpoint(crmInfo.lead_id, prospect.company)}>
                                Log Touchpoint
                            </button>
                        )}
                        <button className="action-btn" style={styles.actionBtn} onClick={() => setShowEmailOptions(!showEmailOptions)}>
                            {showEmailOptions ? 'Cancel' : 'Generate Email'}
                        </button>
                        {prospect.linkedin ? (
                            <a href={`https://${prospect.linkedin}`} target="_blank" rel="noopener noreferrer" style={{...styles.actionBtn, textDecoration: 'none', textAlign: 'center', display: 'inline-flex', alignItems: 'center', justifyContent: 'center'}}>
                                LinkedIn DM
                            </a>
                        ) : (
                            <button className="action-btn btn-disabled" style={styles.actionBtn} disabled>
                                LinkedIn DM
                            </button>
                        )}
                        <button className="action-btn btn-disabled" style={styles.actionBtn} disabled>
                            Call Angle
                        </button>
                        <button className="action-btn" style={styles.actionBtn} onClick={() => onDelete(prospect.id)}>
                            Delete
                        </button>
                    </div>
                </div>
            );
        }

        function EmailModal({ email, prospect, onClose }) {
            const subject = email.subject || '';
            const body = email.body || email || '';
            const fullText = subject ? `Subject: ${subject}\n\n${body}` : body;
            const copyEmail = () => { navigator.clipboard.writeText(fullText); alert('Email copied to clipboard!'); };
            const copySubject = () => { navigator.clipboard.writeText(subject); alert('Subject line copied!'); };
            return (
                <div style={styles.modalOverlay} onClick={onClose}>
                    <div style={styles.modal} onClick={(e) => e.stopPropagation()}>
                        <div style={styles.modalHeader}>
                            <h2 style={{fontSize: '1.2rem'}}>Email for {prospect.company}</h2>
                            <button style={styles.closeBtn} onClick={onClose}>&#10005;</button>
                        </div>
                        {subject && (
                            <div style={styles.subjectRow}>
                                <span style={styles.subjectLabel}>SUBJECT:</span>
                                <span style={styles.subjectText}>{subject}</span>
                                <button style={styles.copySmall} onClick={copySubject} title="Copy subject">&#128203;</button>
                            </div>
                        )}
                        <div style={styles.emailBody}>
                            {body.split('\n').map((line, i) => (
                                <React.Fragment key={i}>{line}<br/></React.Fragment>
                            ))}
                        </div>
                        <div style={styles.modalActions}>
                            <button className="action-btn" style={styles.btnPrimary} onClick={copyEmail}>
                                Copy Full Email
                            </button>
                            <button className="action-btn" style={styles.btn} onClick={onClose}>Close</button>
                        </div>
                    </div>
                </div>
            );
        }

        function DailyDiscovery() {
            const [config, setConfig] = useState(null);
            const [latestRun, setLatestRun] = useState(null);
            const [selectedRun, setSelectedRun] = useState(null);
            const [history, setHistory] = useState([]);
            const [running, setRunning] = useState(false);
            const [status, setStatus] = useState('');
            const [showDigest, setShowDigest] = useState(false);
            const [sourceRefresh, setSourceRefresh] = useState({});
            const [sourceFilters, setSourceFilters] = useState({
                filing: true, permit: true, news: true, press_release: true
            });

            useEffect(() => {
                loadConfig(); loadLatest(); loadHistory(); checkStatus(); loadSourceRefresh();
            }, []);

            useEffect(() => {
                if (!running) return;
                const interval = setInterval(async () => {
                    try {
                        const res = await fetch(`${API_BASE}/api/discovery/status`);
                        const data = await res.json();
                        if (!data.running) {
                            setRunning(false);
                            setStatus('Discovery complete!');
                            loadLatest(); loadHistory(); loadSourceRefresh();
                            setTimeout(() => setStatus(''), 5000);
                        }
                    } catch (e) { console.error('Poll error:', e); }
                }, 5000);
                return () => clearInterval(interval);
            }, [running]);

            const loadConfig = async () => {
                try { const res = await fetch(`${API_BASE}/api/discovery/config`); const data = await res.json(); if (data.success) setConfig(data.config); }
                catch (e) { console.error('Config load error:', e); }
            };
            const loadLatest = async () => {
                try { const res = await fetch(`${API_BASE}/api/discovery/latest`); const data = await res.json(); if (data.success && data.run) { setLatestRun(data.run); setSelectedRun(data.run); } }
                catch (e) { console.error('Latest load error:', e); }
            };
            const loadHistory = async () => {
                try { const res = await fetch(`${API_BASE}/api/discovery/history`); const data = await res.json(); if (data.success) setHistory(data.runs); }
                catch (e) { console.error('History load error:', e); }
            };
            const checkStatus = async () => {
                try { const res = await fetch(`${API_BASE}/api/discovery/status`); const data = await res.json(); if (data.running) { setRunning(true); setStatus('Discovery is running...'); } }
                catch (e) { console.error('Status check error:', e); }
            };
            const loadSourceRefresh = async () => {
                try { const res = await fetch(`${API_BASE}/api/discovery/source-refresh`); const data = await res.json(); if (data.success) setSourceRefresh(data.sources || {}); }
                catch (e) { console.error('Source refresh load error:', e); }
            };
            const triggerRun = async () => {
                try {
                    setRunning(true);
                    setStatus('Starting discovery run — scanning EDGAR, press releases, permits, and news...');
                    const res = await fetch(`${API_BASE}/api/discovery/run`, { method: 'POST' });
                    const data = await res.json();
                    if (!data.success) { setRunning(false); setStatus(data.message); setTimeout(() => setStatus(''), 5000); }
                    else { setStatus('Discovery is running — scanning multiple sources...'); }
                } catch (e) { setRunning(false); setStatus('Failed to start discovery.'); setTimeout(() => setStatus(''), 5000); }
            };
            const loadRunDetail = async (runId) => {
                try { const res = await fetch(`${API_BASE}/api/discovery/run/${runId}`); const data = await res.json(); if (data.success) setSelectedRun(data.run); }
                catch (e) { console.error('Run detail error:', e); }
            };
            const toggleSourceFilter = (source) => { setSourceFilters(prev => ({...prev, [source]: !prev[source]})); };
            const filterSignals = (signals) => {
                if (!signals) return [];
                return signals.filter(s => { const st = s.source_type || 'news'; return sourceFilters[st] !== false; });
            };
            const formatRefreshTime = (isoStr) => {
                if (!isoStr) return 'Never';
                try { return new Date(isoStr).toLocaleString(); } catch (e) { return 'Unknown'; }
            };

            if (!config) return <div style={ds.loadingMsg}>Loading configuration...</div>;

            const results = selectedRun?.results || {};
            const adapterStats = selectedRun?.adapter_stats || {};

            const sourceTypeConfig = {
                filing: { label: 'SEC Filing', color: '#a78bfa', icon: 'F' },
                permit: { label: 'Permit', color: '#fbbf24', icon: 'P' },
                news: { label: 'News', color: '#22d3ee', icon: 'N' },
                press_release: { label: 'Press Release', color: '#fb7185', icon: 'R' },
            };
            const confidenceConfig = {
                high: { color: '#34d399', label: 'HIGH' },
                medium: { color: '#fbbf24', label: 'MED' },
                low: { color: '#94a3b8', label: 'LOW' },
            };

            return (
                <div>
                    <div style={ds.configPanel}>
                        <div style={ds.configHeader}>
                            <h2 style={ds.sectionTitle}>Daily Discovery</h2>
                            <div style={ds.schedule}>
                                Runs daily at {config.schedule_hour}:{String(config.schedule_minute).padStart(2, '0')} AM PT
                            </div>
                        </div>
                        <div style={ds.configGrid}>
                            <div>
                                <div style={ds.configLabel}>Target Cities</div>
                                <div style={ds.chipGroup}>
                                    {config.cities.map((c, i) => (
                                        <span key={i} style={ds.chip}>{c.city}, {c.state}</span>
                                    ))}
                                </div>
                            </div>
                            <div>
                                <div style={ds.configLabel}>ICP Keywords</div>
                                <div style={ds.chipGroup}>
                                    {config.icp_keywords.map((kw, i) => (
                                        <span key={i} style={ds.keywordChip}>{kw}</span>
                                    ))}
                                </div>
                            </div>
                            {config.monitor_operators && config.monitor_operators.length > 0 && (
                                <div>
                                    <div style={ds.configLabel}>Monitored Operators (EDGAR)</div>
                                    <div style={ds.chipGroup}>
                                        {config.monitor_operators.map((op, i) => (
                                            <span key={i} style={ds.operatorChip}>{op}</span>
                                        ))}
                                    </div>
                                </div>
                            )}
                            <div>
                                <div style={ds.configLabel}>Settings</div>
                                <div style={ds.filterRow}>
                                    <span style={ds.filterItem}>Max {config.max_signals_per_day || 10} signals/day</span>
                                    <span style={ds.filterItem}>Delivery: {config.delivery_method}</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    {Object.keys(sourceRefresh).length > 0 && (
                        <div style={ds.sourceRefreshBar}>
                            <div style={ds.configLabel}>Last Refreshed</div>
                            <div style={{display: 'flex', gap: '1.5rem', flexWrap: 'wrap', marginTop: '0.4rem'}}>
                                {Object.entries(sourceTypeConfig).map(([key, cfg]) => {
                                    const info = sourceRefresh[key];
                                    return (
                                        <span key={key} style={{fontSize: '0.8rem', color: cfg.color}}>
                                            [{cfg.icon}] {cfg.label}: {info ? formatRefreshTime(info.last_refreshed_at) : 'Never'}
                                            {info && info.items_found > 0 ? ` (${info.items_found})` : ''}
                                        </span>
                                    );
                                })}
                            </div>
                        </div>
                    )}

                    <div style={ds.actionBar}>
                        <button
                            style={{...styles.btnPrimary, ...(running ? {opacity: 0.5, cursor: 'not-allowed'} : {}), fontSize: '1rem', padding: '0.85rem 2rem'}}
                            onClick={triggerRun}
                            disabled={running}
                        >
                            {running ? 'Running Discovery...' : 'Run Discovery Now'}
                        </button>
                        {selectedRun && (
                            <button className="action-btn" style={{...styles.btn, fontSize: '0.9rem'}} onClick={() => setShowDigest(!showDigest)}>
                                {showDigest ? 'Show Cards' : 'Show Digest'}
                            </button>
                        )}
                        {latestRun && (
                            <span style={ds.lastRun}>
                                Last run: {new Date(latestRun.run_at).toLocaleString()} &middot; {latestRun.total_new} new
                            </span>
                        )}
                    </div>

                    {selectedRun && !showDigest && (
                        <div style={ds.filterBar}>
                            <span style={{fontSize: '0.8rem', color: '#64748b', marginRight: '0.75rem'}}>Filter:</span>
                            {Object.entries(sourceTypeConfig).map(([key, cfg]) => (
                                <button
                                    key={key}
                                    className="filter-pill"
                                    onClick={() => toggleSourceFilter(key)}
                                    style={{
                                        ...ds.filterToggle,
                                        borderColor: sourceFilters[key] ? cfg.color : '#334155',
                                        color: sourceFilters[key] ? cfg.color : '#475569',
                                        background: sourceFilters[key] ? `${cfg.color}15` : 'transparent',
                                    }}
                                >
                                    [{cfg.icon}] {cfg.label}
                                </button>
                            ))}
                        </div>
                    )}

                    {selectedRun && adapterStats && Object.keys(adapterStats).length > 0 && !showDigest && (
                        <div style={ds.adapterStatsBar}>
                            {Object.entries(adapterStats).map(([key, stat]) => (
                                <span key={key} style={{
                                    fontSize: '0.8rem',
                                    color: stat.status === 'ok' ? '#34d399' : stat.status === 'skipped' ? '#94a3b8' : '#ef4444',
                                    padding: '0.25rem 0.6rem',
                                    borderRadius: '12px',
                                    border: `1px solid ${stat.status === 'ok' ? 'rgba(16,185,129,0.3)' : 'rgba(148,163,184,0.3)'}`,
                                }}>
                                    [{(sourceTypeConfig[key] || {icon: '?'}).icon}] {key}: {stat.items} items ({stat.status})
                                </span>
                            ))}
                        </div>
                    )}

                    {status && <div style={styles.searchStatus}><p>{status}</p></div>}
                    {running && (
                        <div style={styles.loading}>
                            <div style={styles.loadingText}>Scanning EDGAR, press releases, permits, and news...</div>
                        </div>
                    )}

                    {showDigest && selectedRun?.digest && (
                        <div style={ds.digestBox}>
                            <pre style={ds.digestText}>{selectedRun.digest}</pre>
                        </div>
                    )}

                    {!showDigest && selectedRun && (
                        <div>
                            {Object.entries(results).map(([location, data]) => {
                                const filtered = filterSignals(data.signals);
                                return (
                                    <div key={location} style={ds.citySection}>
                                        <div style={ds.cityHeader}>
                                            <h3 style={ds.cityTitle}>{location}</h3>
                                            {data.new_count !== undefined && (
                                                <span style={ds.newBadge}>{data.new_count} new</span>
                                            )}
                                        </div>
                                        {data.error && <p style={ds.errorText}>Error: {data.error}</p>}
                                        {!data.error && filtered.length === 0 && (
                                            <p style={ds.noResults}>No new activity signals found</p>
                                        )}
                                        <div style={ds.signalGrid}>
                                            {filtered.map((s, i) => {
                                                const typeLabel = (s.signal_type || 'other').replace(/_/g, ' ');
                                                const typeColor = {
                                                    'new build': '#34d399',
                                                    'under construction': '#22d3ee',
                                                    'permit rezoning': '#fbbf24',
                                                    'acquisition': '#ef4444',
                                                    'sale': '#fb7185',
                                                    'recapitalization': '#a78bfa',
                                                    'financing': '#a78bfa',
                                                }[typeLabel] || '#94a3b8';
                                                const srcCfg = sourceTypeConfig[s.source_type] || sourceTypeConfig.news;
                                                const confCfg = confidenceConfig[s.confidence] || confidenceConfig.medium;
                                                return (
                                                    <div key={i} style={ds.signalCard}>
                                                        <div style={ds.signalCardHeader}>
                                                            <span style={{...ds.signalTypeBadge, borderColor: typeColor, color: typeColor}}>
                                                                {typeLabel}
                                                            </span>
                                                            <span style={{...ds.sourceTypeBadge, borderColor: srcCfg.color, color: srcCfg.color}}>
                                                                [{srcCfg.icon}] {srcCfg.label}
                                                            </span>
                                                            <span style={{...ds.confidenceBadge, color: confCfg.color}}>
                                                                {confCfg.label}
                                                            </span>
                                                        </div>
                                                        {s.entity_name && <div style={ds.entityName}>{s.entity_name}</div>}
                                                        <div style={ds.signalTitle}>{s.title}</div>
                                                        {s.summary && <div style={ds.signalSummary}>{s.summary}</div>}
                                                        <div style={ds.signalMeta}>
                                                            {s.source_name && <span style={ds.signalSource}>{s.source_name}</span>}
                                                            {s.published_at && <span style={ds.signalDate}>{s.published_at}</span>}
                                                        </div>
                                                        {s.url && (
                                                            <a href={s.url} target="_blank" rel="noopener noreferrer" style={ds.signalLink}>
                                                                Read source
                                                            </a>
                                                        )}
                                                    </div>
                                                );
                                            })}
                                        </div>
                                    </div>
                                );
                            })}
                        </div>
                    )}

                    {!selectedRun && !running && (
                        <div style={styles.empty}>
                            <h2 style={styles.emptyTitle}>No discovery runs yet</h2>
                            <p style={styles.emptyText}>Click "Run Discovery Now" to scan multiple sources for BTR activity signals</p>
                            <p style={styles.emptySubtext}>Searches SEC EDGAR filings, press releases, city permits, and CRE news</p>
                        </div>
                    )}

                    {history.length > 0 && (
                        <div style={ds.historySection}>
                            <h3 style={ds.sectionTitle}>Run History</h3>
                            <div style={ds.historyList}>
                                {history.map(run => (
                                    <div
                                        key={run.id}
                                        style={{...ds.historyItem, ...(selectedRun?.id === run.id ? ds.historyItemActive : {})}}
                                        onClick={() => loadRunDetail(run.id)}
                                    >
                                        <span style={ds.historyDate}>{new Date(run.run_at).toLocaleString()}</span>
                                        <span style={ds.historyStats}>{run.total_new} new &middot; {run.city_count} cities</span>
                                        <span style={{...ds.historyStatus, color: run.status === 'completed' ? '#34d399' : '#fbbf24'}}>{run.status}</span>
                                    </div>
                                ))}
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        // ======= STATEWIDE DISCOVERY =======
        const STATEWIDE_STATES = [
            { abbr: 'TX', name: 'Texas' },
            { abbr: 'AZ', name: 'Arizona' },
            { abbr: 'GA', name: 'Georgia' },
            { abbr: 'NC', name: 'North Carolina' },
            { abbr: 'FL', name: 'Florida' },
        ];

        const EVENT_TYPE_COLORS = {
            'acquisition': { bg: 'rgba(239,68,68,0.15)', color: '#f87171' },
            'sale': { bg: 'rgba(236,72,153,0.15)', color: '#f9a8d4' },
            'groundbreaking': { bg: 'rgba(16,185,129,0.15)', color: '#34d399' },
            'permit': { bg: 'rgba(245,158,11,0.15)', color: '#fcd34d' },
            'rezoning': { bg: 'rgba(245,158,11,0.15)', color: '#fcd34d' },
            'financing': { bg: 'rgba(168,85,247,0.15)', color: '#c4b5fd' },
            'JV': { bg: 'rgba(168,85,247,0.15)', color: '#c4b5fd' },
            'construction': { bg: 'rgba(6,182,212,0.15)', color: '#67e8f9' },
            'other': { bg: 'rgba(148,163,184,0.15)', color: '#94a3b8' },
        };

        function StatewideDiscovery() {
            const [rankings, setRankings] = useState([]);
            const [selectedState, setSelectedState] = useState(null);
            const [stateData, setStateData] = useState(null);
            const [loading, setLoading] = useState(false);
            const [scanningState, setScanningState] = useState(null);
            const [status, setStatus] = useState('');

            useEffect(() => { loadRankings(); }, []);

            const loadRankings = async () => {
                try {
                    const res = await fetch(`${API_BASE}/api/discovery/state-rankings`);
                    const data = await res.json();
                    if (data.success) setRankings(data.rankings);
                } catch (e) { console.error('Rankings load error:', e); }
            };

            const scanState = async (stateAbbr) => {
                setScanningState(stateAbbr);
                setStatus(`Scanning ${stateAbbr}...`);
                try {
                    const res = await fetch(`${API_BASE}/api/discovery/statewide/run`, {
                        method: 'POST', headers: {'Content-Type':'application/json'},
                        body: JSON.stringify({ state: stateAbbr })
                    });
                    const data = await res.json();
                    if (data.success) {
                        setStatus(`Found ${data.count} signals in ${stateAbbr}`);
                        loadRankings();
                        if (selectedState === stateAbbr) loadStateSummary(stateAbbr);
                    } else {
                        setStatus(data.message || 'Scan failed');
                    }
                } catch (e) { setStatus('Scan error: ' + e.message); }
                setScanningState(null);
                setTimeout(() => setStatus(''), 5000);
            };

            const scanAllStates = async () => {
                for (const s of STATEWIDE_STATES) {
                    await scanState(s.abbr);
                }
            };

            const loadStateSummary = async (stateAbbr) => {
                setSelectedState(stateAbbr);
                setLoading(true);
                try {
                    const res = await fetch(`${API_BASE}/api/discovery/state-summary?state=${stateAbbr}`);
                    const data = await res.json();
                    if (data.success) setStateData(data);
                } catch (e) { console.error('State summary error:', e); }
                setLoading(false);
            };

            // Compute intensity for heat grid
            const maxScore = Math.max(1, ...rankings.map(r => r.state_activity_score));

            return (
                <div>
                    <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:'1.5rem',flexWrap:'wrap',gap:'0.75rem'}}>
                        <div>
                            <h2 style={{fontFamily:"'Orbitron',sans-serif",fontSize:'1.3rem',fontWeight:700,color:'#34d399',marginBottom:'0.3rem'}}>Statewide Intelligence</h2>
                            <p style={{fontSize:'0.85rem',color:'#64748b'}}>BTR activity scanning across TX, AZ, GA, NC, FL</p>
                        </div>
                        <button
                            className="action-btn"
                            style={{...styles.btnPrimary,fontSize:'0.9rem',padding:'0.65rem 1.5rem',...(scanningState?{opacity:0.5,cursor:'not-allowed'}:{})}}
                            onClick={scanAllStates}
                            disabled={!!scanningState}
                        >
                            {scanningState ? `Scanning ${scanningState}...` : 'Scan All States'}
                        </button>
                    </div>

                    {status && <div style={styles.searchStatus}><p>{status}</p></div>}

                    {/* State Heat Grid */}
                    <div style={{display:'grid',gridTemplateColumns:'repeat(auto-fill,minmax(240px,1fr))',gap:'1rem',marginBottom:'2rem'}}>
                        {STATEWIDE_STATES.map(s => {
                            const ranking = rankings.find(r => r.state === s.abbr) || {};
                            const score = ranking.state_activity_score || 0;
                            const intensity = maxScore > 0 ? score / maxScore : 0;
                            const isSelected = selectedState === s.abbr;
                            const borderColor = intensity > 0.7 ? '#34d399' : intensity > 0.4 ? '#fbbf24' : intensity > 0 ? '#3b82f6' : '#334155';
                            const glowColor = intensity > 0.7 ? 'rgba(16,185,129,0.2)' : intensity > 0.4 ? 'rgba(251,191,36,0.15)' : 'transparent';
                            return (
                                <div key={s.abbr} onClick={() => loadStateSummary(s.abbr)} style={{
                                    background: isSelected ? '#263548' : '#1e293b',
                                    border: `2px solid ${isSelected ? '#34d399' : borderColor}`,
                                    borderRadius:'12px',padding:'1.25rem',cursor:'pointer',
                                    boxShadow: isSelected ? '0 0 20px rgba(16,185,129,0.15)' : `0 0 12px ${glowColor}`,
                                    transition:'all 0.2s',
                                }}>
                                    <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:'0.75rem'}}>
                                        <div>
                                            <div style={{fontFamily:"'Orbitron',sans-serif",fontSize:'1.6rem',fontWeight:900,color:'#f1f5f9'}}>{s.abbr}</div>
                                            <div style={{fontSize:'0.8rem',color:'#64748b'}}>{s.name}</div>
                                        </div>
                                        <div style={{
                                            width:'3rem',height:'3rem',borderRadius:'50%',display:'flex',alignItems:'center',justifyContent:'center',
                                            border:`2px solid ${borderColor}`,fontFamily:"'JetBrains Mono',monospace",fontSize:'0.9rem',fontWeight:700,
                                            color: intensity > 0.4 ? '#f1f5f9' : '#64748b',
                                            boxShadow: intensity > 0.5 ? `0 0 10px ${glowColor}` : 'none',
                                        }}>{score}</div>
                                    </div>
                                    <div style={{display:'flex',gap:'1rem',fontSize:'0.8rem',color:'#94a3b8'}}>
                                        <span>{ranking.total_signals || 0} signals</span>
                                        <span>{ranking.capital_events_count || 0} capital</span>
                                        <span>{ranking.construction_signals_count || 0} construction</span>
                                    </div>
                                    {ranking.top_cities && ranking.top_cities.length > 0 && (
                                        <div style={{marginTop:'0.5rem',display:'flex',gap:'0.4rem',flexWrap:'wrap'}}>
                                            {ranking.top_cities.map((tc,i) => (
                                                <span key={i} style={{fontSize:'0.7rem',padding:'0.15rem 0.45rem',borderRadius:'4px',
                                                    background:'rgba(16,185,129,0.1)',color:'#6ee7b7'}}>{tc.city}</span>
                                            ))}
                                        </div>
                                    )}
                                    <button className="action-btn" style={{...styles.actionBtn,marginTop:'0.75rem',fontSize:'0.75rem',
                                        ...(scanningState===s.abbr?{opacity:0.5}:{})}}
                                        onClick={(e) => { e.stopPropagation(); scanState(s.abbr); }}
                                        disabled={!!scanningState}>
                                        {scanningState===s.abbr ? 'Scanning...' : 'Scan'}
                                    </button>
                                </div>
                            );
                        })}
                    </div>

                    {/* State Detail */}
                    {selectedState && loading && <div style={styles.loading}><div style={styles.loadingText}>Loading {selectedState}...</div></div>}

                    {selectedState && !loading && stateData && (
                        <div>
                            <h3 style={{fontFamily:"'Orbitron',sans-serif",fontSize:'1.2rem',fontWeight:700,color:'#22d3ee',marginBottom:'1rem'}}>
                                {STATEWIDE_STATES.find(s=>s.abbr===selectedState)?.name} — Detail
                            </h3>

                            {/* Top Cities 7d */}
                            {stateData.top_cities_7d && stateData.top_cities_7d.length > 0 && (
                                <div style={{marginBottom:'1.5rem'}}>
                                    <div style={{fontSize:'0.75rem',color:'#64748b',textTransform:'uppercase',fontWeight:600,letterSpacing:'0.05em',marginBottom:'0.5rem'}}>Top Cities (7-Day Activity)</div>
                                    <div style={{display:'flex',gap:'0.75rem',flexWrap:'wrap'}}>
                                        {stateData.top_cities_7d.map((tc,i) => (
                                            <div key={i} style={{background:'#1e293b',border:'1px solid #334155',borderRadius:'10px',padding:'0.85rem 1.25rem',minWidth:'160px'}}>
                                                <div style={{fontFamily:"'Orbitron',sans-serif",fontSize:'1rem',fontWeight:700,color:'#f1f5f9'}}>{tc.city}</div>
                                                <div style={{display:'flex',gap:'0.75rem',marginTop:'0.3rem',fontSize:'0.8rem',color:'#94a3b8'}}>
                                                    <span>Score: <b style={{color:'#34d399'}}>{tc.activity_score}</b></span>
                                                    <span>{tc.signals_count} signals</span>
                                                </div>
                                                {tc.dominant_event_types && (
                                                    <div style={{display:'flex',gap:'0.3rem',marginTop:'0.4rem',flexWrap:'wrap'}}>
                                                        {tc.dominant_event_types.map((et,j) => {
                                                            const ec = EVENT_TYPE_COLORS[et] || EVENT_TYPE_COLORS.other;
                                                            return <span key={j} style={{fontSize:'0.65rem',padding:'0.1rem 0.4rem',borderRadius:'4px',background:ec.bg,color:ec.color}}>{et}</span>;
                                                        })}
                                                    </div>
                                                )}
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            )}

                            {/* Signal List */}
                            <div style={{fontSize:'0.75rem',color:'#64748b',textTransform:'uppercase',fontWeight:600,letterSpacing:'0.05em',marginBottom:'0.75rem'}}>
                                All Signals ({stateData.total_signals || 0})
                            </div>
                            {(!stateData.items || stateData.items.length === 0) && (
                                <div style={styles.empty}>
                                    <p style={styles.emptyText}>No signals found. Click "Scan" on the state tile above to search.</p>
                                </div>
                            )}
                            <div style={{display:'grid',gridTemplateColumns:'repeat(auto-fill,minmax(360px,1fr))',gap:'0.75rem'}}>
                                {(stateData.items || []).map((item, i) => {
                                    const ec = EVENT_TYPE_COLORS[item.event_type] || EVENT_TYPE_COLORS.other;
                                    const confColor = item.confidence === 'high' ? '#34d399' : item.confidence === 'medium' ? '#fbbf24' : '#94a3b8';
                                    return (
                                        <div key={i} style={{background:'#1e293b',border:'1px solid #334155',borderRadius:'10px',padding:'1rem'}}>
                                            <div style={{display:'flex',gap:'0.5rem',alignItems:'center',marginBottom:'0.5rem',flexWrap:'wrap'}}>
                                                <span style={{fontSize:'0.7rem',padding:'0.15rem 0.5rem',borderRadius:'9999px',fontWeight:600,
                                                    background:ec.bg,color:ec.color,textTransform:'uppercase'}}>{item.event_type}</span>
                                                <span style={{fontSize:'0.7rem',color:confColor,fontWeight:600}}>{(item.confidence||'').toUpperCase()}</span>
                                                {item.city && item.city !== 'Unknown' && (
                                                    <span style={{fontSize:'0.75rem',color:'#22d3ee'}}>{item.city}, {item.state}</span>
                                                )}
                                            </div>
                                            {item.company && <div style={{fontSize:'0.9rem',fontWeight:600,color:'#f1f5f9',marginBottom:'0.25rem'}}>{item.company}</div>}
                                            <div style={{fontSize:'0.85rem',color:'#cbd5e1',marginBottom:'0.4rem',lineHeight:'1.4'}}>{item.summary || item.title}</div>
                                            <div style={{display:'flex',gap:'0.75rem',flexWrap:'wrap',fontSize:'0.75rem',color:'#64748b'}}>
                                                {item.units && <span>Units: {item.units}</span>}
                                                {item.date && <span>{item.date}</span>}
                                            </div>
                                            {item.url && <a href={item.url} target="_blank" rel="noopener noreferrer" style={{color:'#22d3ee',textDecoration:'none',fontSize:'0.8rem',display:'inline-block',marginTop:'0.3rem'}}>Read source</a>}
                                        </div>
                                    );
                                })}
                            </div>
                        </div>
                    )}

                    {!selectedState && rankings.length === 0 && (
                        <div style={styles.empty}>
                            <h2 style={styles.emptyTitle}>No statewide data yet</h2>
                            <p style={styles.emptyText}>Click "Scan All States" or select a state to begin scanning</p>
                        </div>
                    )}
                </div>
            );
        }

        // ======= TOUCHPOINT MODAL =======
        function TouchpointModal({ target, onClose, onSaved }) {
            const [type, setType] = useState('Call');
            const [outcome, setOutcome] = useState('');
            const [notes, setNotes] = useState('');
            const [nextFollowup, setNextFollowup] = useState('');
            const [saving, setSaving] = useState(false);

            const handleSave = async () => {
                setSaving(true);
                try {
                    const body = { type, outcome: outcome || null, notes: notes || null };
                    if (nextFollowup) body.next_followup_at = new Date(nextFollowup).toISOString();
                    const res = await fetch(`${API_BASE}/api/crm/leads/${target.lead_id}/touchpoints`, {
                        method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(body)
                    });
                    const data = await res.json();
                    if (data.success) { onSaved(); onClose(); }
                } catch (e) { console.error('Touchpoint save error:', e); }
                setSaving(false);
            };

            return (
                <div style={styles.modalOverlay} onClick={onClose}>
                    <div style={{...styles.modal,maxWidth:'480px'}} onClick={e => e.stopPropagation()}>
                        <div style={styles.modalHeader}>
                            <h2 style={{fontSize:'1.1rem'}}>Log Touchpoint — {target.company_name}</h2>
                            <button style={styles.closeBtn} onClick={onClose}>&#10005;</button>
                        </div>
                        <div style={{display:'flex',flexDirection:'column',gap:'0.85rem'}}>
                            <div>
                                <label style={{fontSize:'0.75rem',color:'#64748b',fontWeight:600,textTransform:'uppercase',display:'block',marginBottom:'0.3rem'}}>Type</label>
                                <select style={{...styles.select,width:'100%'}} value={type} onChange={e=>setType(e.target.value)}>
                                    <option value="Call">Call</option>
                                    <option value="Email">Email</option>
                                    <option value="LinkedIn">LinkedIn</option>
                                    <option value="Meeting">Meeting</option>
                                    <option value="Quote">Quote</option>
                                    <option value="Other">Other</option>
                                </select>
                            </div>
                            <div>
                                <label style={{fontSize:'0.75rem',color:'#64748b',fontWeight:600,textTransform:'uppercase',display:'block',marginBottom:'0.3rem'}}>Outcome</label>
                                <select style={{...styles.select,width:'100%'}} value={outcome} onChange={e=>setOutcome(e.target.value)}>
                                    <option value="">— Select —</option>
                                    <option value="Connected">Connected</option>
                                    <option value="Left Voicemail">Left Voicemail</option>
                                    <option value="No Answer">No Answer</option>
                                    <option value="Meeting Set">Meeting Set</option>
                                    <option value="Sent Info">Sent Info</option>
                                    <option value="Not Interested">Not Interested</option>
                                    <option value="Follow Up Later">Follow Up Later</option>
                                </select>
                            </div>
                            <div>
                                <label style={{fontSize:'0.75rem',color:'#64748b',fontWeight:600,textTransform:'uppercase',display:'block',marginBottom:'0.3rem'}}>Notes</label>
                                <textarea rows={3} value={notes} onChange={e=>setNotes(e.target.value)} placeholder="Call notes..."
                                    style={{...styles.input,width:'100%',minWidth:0,resize:'vertical',fontFamily:"'Inter',sans-serif"}} />
                            </div>
                            <div>
                                <label style={{fontSize:'0.75rem',color:'#64748b',fontWeight:600,textTransform:'uppercase',display:'block',marginBottom:'0.3rem'}}>Next Follow-up</label>
                                <input type="date" value={nextFollowup} onChange={e=>setNextFollowup(e.target.value)}
                                    style={{...styles.input,width:'100%',minWidth:0}} />
                            </div>
                            <div style={{display:'flex',gap:'0.75rem',justifyContent:'flex-end'}}>
                                <button className="action-btn" style={styles.btn} onClick={onClose}>Cancel</button>
                                <button className="action-btn" style={{...styles.btnPrimary,...(saving?{opacity:0.5}:{})}} onClick={handleSave} disabled={saving}>
                                    {saving ? 'Saving...' : 'Save Touchpoint'}
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        // ======= PIPELINE PAGE =======
        function PipelinePage({ user }) {
            const [leads, setLeads] = useState([]);
            const [loading, setLoading] = useState(true);
            const [filter, setFilter] = useState('all'); // status filter
            const [ownerFilter, setOwnerFilter] = useState('me');
            const [touchpointTarget, setTouchpointTarget] = useState(null);

            useEffect(() => { loadLeads(); }, [filter, ownerFilter]);

            const loadLeads = async () => {
                setLoading(true);
                let url = `${API_BASE}/api/crm/leads?owner=${ownerFilter}`;
                if (filter !== 'all') url += `&status=${filter}`;
                try {
                    const res = await fetch(url);
                    const data = await res.json();
                    if (data.success) setLeads(data.leads);
                } catch (e) { console.error('Pipeline load error:', e); }
                setLoading(false);
            };

            const updateLead = async (leadId, field, value) => {
                try {
                    await fetch(`${API_BASE}/api/crm/leads/${leadId}`, {
                        method: 'PATCH', headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ [field]: value })
                    });
                    loadLeads();
                } catch (e) { console.error('Lead update error:', e); }
            };

            const statusPill = (active, label) => ({
                fontSize:'0.8rem', padding:'0.35rem 0.75rem', borderRadius:'9999px',
                border:`1px solid ${active ? '#34d399' : '#334155'}`,
                background: active ? 'rgba(16,185,129,0.15)' : 'transparent',
                color: active ? '#34d399' : '#94a3b8', cursor:'pointer',
                fontFamily:'Inter,sans-serif', fontWeight:500,
            });

            return (
                <div>
                    <div style={{display:'flex',gap:'0.5rem',flexWrap:'wrap',marginBottom:'1.5rem',alignItems:'center'}}>
                        <span style={{fontSize:'0.75rem',color:'#64748b',textTransform:'uppercase',fontWeight:600,marginRight:'0.25rem'}}>Owner</span>
                        <button className="filter-pill" style={statusPill(ownerFilter==='me','Me')} onClick={() => setOwnerFilter('me')}>My Leads</button>
                        {user?.role === 'admin' && (
                            <React.Fragment>
                                <button className="filter-pill" style={statusPill(ownerFilter==='unassigned','Unassigned')} onClick={() => setOwnerFilter('unassigned')}>Unassigned</button>
                                <button className="filter-pill" style={statusPill(ownerFilter==='all','All')} onClick={() => setOwnerFilter('all')}>All</button>
                            </React.Fragment>
                        )}
                        <span style={{fontSize:'0.75rem',color:'#64748b',textTransform:'uppercase',fontWeight:600,marginLeft:'1rem',marginRight:'0.25rem'}}>Status</span>
                        <button className="filter-pill" style={statusPill(filter==='all','All')} onClick={() => setFilter('all')}>All</button>
                        {CRM_STATUSES.map(s => (
                            <button key={s} className="filter-pill" style={statusPill(filter===s,s)} onClick={() => setFilter(s)}>{s}</button>
                        ))}
                    </div>

                    {loading && <div style={styles.loading}><div style={styles.loadingText}>Loading pipeline...</div></div>}

                    {!loading && leads.length === 0 && (
                        <div style={styles.empty}>
                            <h2 style={styles.emptyTitle}>No leads in pipeline</h2>
                            <p style={styles.emptyText}>Save prospects to your pipeline from the search tab</p>
                        </div>
                    )}

                    {!loading && leads.length > 0 && (
                        <div style={{display:'flex',flexDirection:'column',gap:'0.75rem'}}>
                            {leads.map(lead => (
                                <div key={lead.id} style={{background:'#1e293b',border:'1px solid #334155',borderRadius:'12px',padding:'1rem',display:'flex',alignItems:'center',gap:'1rem',flexWrap:'wrap'}}>
                                    <div style={{flex:1,minWidth:'200px'}}>
                                        <div style={{fontFamily:"'Orbitron',sans-serif",fontSize:'1rem',fontWeight:700,color:'#f1f5f9',marginBottom:'0.2rem'}}>{lead.company_name}</div>
                                        {lead.owner_name && <span style={{fontSize:'0.75rem',color:'#64748b'}}>Owner: {lead.owner_name}</span>}
                                    </div>
                                    <select style={{...styles.select,fontSize:'0.8rem',padding:'0.35rem 0.5rem'}} value={lead.status}
                                        onChange={e => updateLead(lead.id, 'status', e.target.value)}>
                                        {CRM_STATUSES.map(s => <option key={s} value={s}>{s}</option>)}
                                    </select>
                                    <div style={{display:'flex',alignItems:'center',gap:'0.5rem'}}>
                                        <label style={{fontSize:'0.7rem',color:'#64748b'}}>Follow-up:</label>
                                        <input type="date" style={{...styles.input,minWidth:'130px',fontSize:'0.8rem',padding:'0.3rem 0.5rem'}}
                                            value={lead.next_followup_at ? lead.next_followup_at.split('T')[0] : ''}
                                            onChange={e => updateLead(lead.id, 'next_followup_at', e.target.value ? new Date(e.target.value).toISOString() : null)} />
                                    </div>
                                    {lead.last_touch_at && <span style={{fontSize:'0.7rem',color:'#475569'}}>Last touch: {new Date(lead.last_touch_at).toLocaleDateString()}</span>}
                                    <button className="action-btn" style={styles.actionBtn} onClick={() => setTouchpointTarget({lead_id:lead.id,company_name:lead.company_name})}>
                                        Log Touchpoint
                                    </button>
                                </div>
                            ))}
                        </div>
                    )}

                    {touchpointTarget && (
                        <TouchpointModal target={touchpointTarget} onClose={() => setTouchpointTarget(null)} onSaved={loadLeads} />
                    )}
                </div>
            );
        }

        // ======= FOLLOW-UPS DUE PAGE =======
        function FollowUpsPage({ user }) {
            const [leads, setLeads] = useState([]);
            const [loading, setLoading] = useState(true);
            const [touchpointTarget, setTouchpointTarget] = useState(null);

            useEffect(() => { loadDueLeads(); }, []);

            const loadDueLeads = async () => {
                setLoading(true);
                try {
                    const res = await fetch(`${API_BASE}/api/crm/leads?due=1`);
                    const data = await res.json();
                    if (data.success) setLeads(data.leads);
                } catch (e) { console.error('Follow-ups load error:', e); }
                setLoading(false);
            };

            const updateLead = async (leadId, field, value) => {
                try {
                    await fetch(`${API_BASE}/api/crm/leads/${leadId}`, {
                        method: 'PATCH', headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ [field]: value })
                    });
                    loadDueLeads();
                } catch (e) { console.error('Lead update error:', e); }
            };

            return (
                <div>
                    <div style={{marginBottom:'1.5rem'}}>
                        <h2 style={{fontFamily:"'Orbitron',sans-serif",fontSize:'1.3rem',fontWeight:700,color:'#ef4444',marginBottom:'0.3rem'}}>Follow-ups Due</h2>
                        <p style={{fontSize:'0.85rem',color:'#64748b'}}>Leads with follow-up dates at or before today</p>
                    </div>

                    {loading && <div style={styles.loading}><div style={styles.loadingText}>Loading...</div></div>}

                    {!loading && leads.length === 0 && (
                        <div style={styles.empty}>
                            <h2 style={styles.emptyTitle}>No follow-ups due</h2>
                            <p style={styles.emptyText}>All caught up! Set follow-up dates on your pipeline leads.</p>
                        </div>
                    )}

                    {!loading && leads.length > 0 && (
                        <div style={{display:'flex',flexDirection:'column',gap:'0.75rem'}}>
                            {leads.map(lead => {
                                const dueDate = lead.next_followup_at ? new Date(lead.next_followup_at) : null;
                                const isOverdue = dueDate && dueDate < new Date(new Date().toDateString());
                                return (
                                    <div key={lead.id} style={{
                                        background:'#1e293b',border:`1px solid ${isOverdue ? 'rgba(239,68,68,0.4)' : '#334155'}`,
                                        borderLeft: isOverdue ? '4px solid #ef4444' : '4px solid #fbbf24',
                                        borderRadius:'12px',padding:'1rem',display:'flex',alignItems:'center',gap:'1rem',flexWrap:'wrap'}}>
                                        <div style={{flex:1,minWidth:'200px'}}>
                                            <div style={{fontFamily:"'Orbitron',sans-serif",fontSize:'1rem',fontWeight:700,color:'#f1f5f9',marginBottom:'0.2rem'}}>{lead.company_name}</div>
                                            <div style={{display:'flex',gap:'0.5rem',alignItems:'center'}}>
                                                <span style={{fontSize:'0.75rem',padding:'0.15rem 0.45rem',borderRadius:'4px',fontWeight:600,
                                                    background:(CRM_STATUS_COLORS[lead.status]||CRM_STATUS_COLORS.New).bg,
                                                    color:(CRM_STATUS_COLORS[lead.status]||CRM_STATUS_COLORS.New).color}}>{lead.status}</span>
                                                {lead.owner_name && <span style={{fontSize:'0.75rem',color:'#64748b'}}>{lead.owner_name}</span>}
                                            </div>
                                        </div>
                                        <div style={{fontSize:'0.85rem',color: isOverdue ? '#f87171' : '#fbbf24',fontWeight:600}}>
                                            {isOverdue ? 'OVERDUE' : 'DUE TODAY'}: {dueDate ? dueDate.toLocaleDateString() : '—'}
                                        </div>
                                        <input type="date" style={{...styles.input,minWidth:'130px',fontSize:'0.8rem',padding:'0.3rem 0.5rem'}}
                                            value={lead.next_followup_at ? lead.next_followup_at.split('T')[0] : ''}
                                            onChange={e => updateLead(lead.id, 'next_followup_at', e.target.value ? new Date(e.target.value).toISOString() : null)} />
                                        <button className="action-btn" style={styles.actionBtn} onClick={() => setTouchpointTarget({lead_id:lead.id,company_name:lead.company_name})}>
                                            Log Touchpoint
                                        </button>
                                    </div>
                                );
                            })}
                        </div>
                    )}

                    {touchpointTarget && (
                        <TouchpointModal target={touchpointTarget} onClose={() => setTouchpointTarget(null)} onSaved={loadDueLeads} />
                    )}
                </div>
            );
        }

        // Discovery styles
        const ds = {
            tabBar: { display: 'flex', gap: '0.25rem', marginBottom: '2rem', borderBottom: '2px solid #334155', paddingBottom: '0' },
            tab: { background: 'transparent', border: 'none', color: '#64748b', padding: '0.75rem 1.5rem', fontSize: '0.95rem', fontWeight: 600, cursor: 'pointer', borderBottom: '2px solid transparent', marginBottom: '-2px', fontFamily: "'Orbitron', sans-serif", transition: 'color 0.2s, border-color 0.2s' },
            tabActive: { color: '#34d399', borderBottomColor: '#34d399' },
            loadingMsg: { textAlign: 'center', padding: '3rem', color: '#94a3b8' },
            configPanel: { background: '#1e293b', border: '1px solid #334155', borderRadius: '12px', padding: '1.5rem', marginBottom: '2rem' },
            configHeader: { display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '1rem', flexWrap: 'wrap', gap: '0.5rem' },
            sectionTitle: { fontFamily: "'Orbitron', sans-serif", fontSize: '1.3rem', fontWeight: 700, color: '#34d399' },
            schedule: { color: '#94a3b8', fontSize: '0.9rem' },
            configGrid: { display: 'grid', gap: '1rem' },
            configLabel: { fontSize: '0.75rem', color: '#64748b', textTransform: 'uppercase', fontWeight: 600, marginBottom: '0.5rem', letterSpacing: '0.05em' },
            chipGroup: { display: 'flex', flexWrap: 'wrap', gap: '0.5rem' },
            chip: { background: 'rgba(16,185,129,0.1)', border: '1px solid rgba(16,185,129,0.3)', borderRadius: '20px', padding: '0.3rem 0.8rem', fontSize: '0.85rem', color: '#34d399' },
            keywordChip: { background: 'rgba(6,182,212,0.1)', border: '1px solid rgba(6,182,212,0.2)', borderRadius: '20px', padding: '0.3rem 0.8rem', fontSize: '0.8rem', color: '#22d3ee' },
            sourceChip: { background: 'rgba(251,191,36,0.1)', border: '1px solid rgba(251,191,36,0.3)', borderRadius: '20px', padding: '0.3rem 0.8rem', fontSize: '0.8rem', color: '#fbbf24' },
            operatorChip: { background: 'rgba(239,68,68,0.1)', border: '1px solid rgba(239,68,68,0.3)', borderRadius: '20px', padding: '0.3rem 0.8rem', fontSize: '0.8rem', color: '#f87171' },
            filterRow: { display: 'flex', gap: '1.5rem', flexWrap: 'wrap' },
            filterItem: { color: '#f1f5f9', fontSize: '0.9rem' },
            actionBar: { display: 'flex', gap: '1rem', alignItems: 'center', marginBottom: '2rem', flexWrap: 'wrap' },
            lastRun: { color: '#94a3b8', fontSize: '0.85rem' },
            digestBox: { background: '#0f172a', border: '1px solid #334155', borderRadius: '12px', padding: '1.5rem', marginBottom: '2rem', overflow: 'auto', maxHeight: '600px' },
            digestText: { fontFamily: "'JetBrains Mono', monospace", fontSize: '0.85rem', color: '#f1f5f9', whiteSpace: 'pre-wrap', lineHeight: '1.5', margin: 0 },
            citySection: { marginBottom: '2rem' },
            cityHeader: { display: 'flex', alignItems: 'center', gap: '0.75rem', marginBottom: '1rem', paddingBottom: '0.5rem', borderBottom: '1px solid #334155' },
            cityTitle: { fontFamily: "'Orbitron', sans-serif", fontSize: '1.1rem', fontWeight: 700, color: '#22d3ee' },
            newBadge: { background: 'rgba(16,185,129,0.15)', border: '1px solid #34d399', borderRadius: '12px', padding: '0.15rem 0.6rem', fontSize: '0.75rem', color: '#34d399', fontWeight: 600 },
            errorText: { color: '#ef4444', fontSize: '0.9rem' },
            noResults: { color: '#94a3b8', fontSize: '0.9rem', fontStyle: 'italic' },
            signalGrid: { display: 'grid', gridTemplateColumns: 'repeat(auto-fill, minmax(360px, 1fr))', gap: '1rem' },
            signalCard: { background: '#1e293b', border: '1px solid #334155', borderRadius: '10px', padding: '1.25rem', transition: 'all 0.2s' },
            signalCardHeader: { display: 'flex', alignItems: 'center', gap: '0.75rem', marginBottom: '0.75rem', flexWrap: 'wrap' },
            signalTypeBadge: { border: '1px solid', borderRadius: '20px', padding: '0.2rem 0.7rem', fontSize: '0.75rem', fontWeight: 600, textTransform: 'uppercase', letterSpacing: '0.03em' },
            entityName: { fontFamily: "'Orbitron', sans-serif", fontSize: '0.95rem', fontWeight: 600, color: '#f1f5f9' },
            signalTitle: { fontSize: '0.9rem', color: '#f1f5f9', marginBottom: '0.5rem', lineHeight: '1.4' },
            signalSummary: { fontSize: '0.85rem', color: '#94a3b8', marginBottom: '0.75rem', lineHeight: '1.5' },
            signalMeta: { display: 'flex', gap: '1rem', marginBottom: '0.5rem', flexWrap: 'wrap' },
            signalSource: { fontSize: '0.8rem', color: '#fbbf24' },
            signalDate: { fontSize: '0.8rem', color: '#94a3b8' },
            signalLink: { color: '#22d3ee', textDecoration: 'none', fontSize: '0.85rem', display: 'inline-block', marginTop: '0.25rem' },
            historySection: { marginTop: '2rem', background: '#1e293b', border: '1px solid #334155', borderRadius: '12px', padding: '1.5rem' },
            historyList: { display: 'flex', flexDirection: 'column', gap: '0.5rem', marginTop: '1rem' },
            historyItem: { display: 'flex', justifyContent: 'space-between', alignItems: 'center', padding: '0.75rem 1rem', borderRadius: '8px', cursor: 'pointer', background: '#0f172a', border: '1px solid transparent', transition: 'all 0.2s' },
            historyItemActive: { border: '1px solid #34d399', background: 'rgba(16,185,129,0.05)' },
            historyDate: { fontSize: '0.85rem', color: '#f1f5f9' },
            historyStats: { fontSize: '0.85rem', color: '#94a3b8' },
            historyStatus: { fontSize: '0.8rem', fontWeight: 600, textTransform: 'uppercase' },
            sourceRefreshBar: { background: '#1e293b', border: '1px solid #334155', borderRadius: '10px', padding: '1rem 1.25rem', marginBottom: '1.5rem' },
            filterBar: { display: 'flex', alignItems: 'center', gap: '0.5rem', marginBottom: '1.5rem', flexWrap: 'wrap' },
            filterToggle: { background: 'transparent', border: '1px solid #334155', borderRadius: '20px', padding: '0.3rem 0.8rem', fontSize: '0.8rem', cursor: 'pointer', fontFamily: "'Inter', sans-serif", transition: 'all 0.2s' },
            sourceTypeBadge: { border: '1px solid', borderRadius: '20px', padding: '0.15rem 0.55rem', fontSize: '0.7rem', fontWeight: 600 },
            confidenceBadge: { fontSize: '0.65rem', fontWeight: 700, letterSpacing: '0.05em', padding: '0.15rem 0.4rem', borderRadius: '4px', background: 'rgba(255,255,255,0.05)' },
            adapterStatsBar: { display: 'flex', gap: '0.75rem', flexWrap: 'wrap', marginBottom: '1.5rem' },
        };

        // Main styles
        const styles = {
            container: { maxWidth: '1400px', margin: '0 auto', padding: '2rem', minHeight: '100vh' },
            header: { marginBottom: '2.5rem', textAlign: 'center' },
            title: { fontFamily: "'Orbitron', sans-serif", fontSize: '2.5rem', fontWeight: 900, background: 'linear-gradient(135deg, #34d399 0%, #22d3ee 100%)', WebkitBackgroundClip: 'text', WebkitTextFillColor: 'transparent', marginBottom: '0.5rem', letterSpacing: '0.05em' },
            subtitle: { fontSize: '1rem', color: '#64748b', fontWeight: 400 },
            statsBar: { display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(200px, 1fr))', gap: '1rem', marginBottom: '2rem' },
            statCard: { background: '#1e293b', border: '1px solid #334155', borderRadius: '12px', padding: '1.25rem' },
            statLabel: { fontSize: '0.75rem', color: '#64748b', textTransform: 'uppercase', marginBottom: '0.4rem', fontWeight: 600, letterSpacing: '0.05em' },
            statValue: { fontFamily: "'JetBrains Mono', monospace", fontSize: '1.8rem', fontWeight: 700, color: '#34d399', lineHeight: '1.2', display: 'block', minHeight: '2.2rem' },
            pulse: { animation: 'pulse 2s ease-in-out infinite' },
            controls: {
                position: 'sticky', top: 0, zIndex: 20,
                background: 'rgba(2,6,23,0.80)',
                backdropFilter: 'blur(12px)',
                WebkitBackdropFilter: 'blur(12px)',
                borderBottom: '1px solid #1e293b',
                padding: '0.75rem 1rem',
                marginBottom: '2rem',
                display: 'flex', flexDirection: 'column', gap: '0.65rem',
            },
            btn: { background: 'transparent', border: '1px solid #334155', color: '#94a3b8', padding: '0.6rem 1.2rem', borderRadius: '8px', fontSize: '0.85rem', cursor: 'pointer', fontFamily: "'Inter', sans-serif", transition: 'all 0.2s' },
            btnPrimary: { background: '#10b981', border: 'none', color: '#0f172a', padding: '0.6rem 1.5rem', borderRadius: '8px', fontSize: '0.9rem', fontWeight: 600, cursor: 'pointer', fontFamily: "'Inter', sans-serif", transition: 'all 0.2s' },
            input: { background: '#1e293b', border: '1px solid #334155', color: '#f1f5f9', padding: '0.6rem 1rem', borderRadius: '8px', fontSize: '0.85rem', minWidth: '220px', fontFamily: "'Inter', sans-serif", outline: 'none' },
            select: { background: '#1e293b', border: '1px solid #334155', color: '#f1f5f9', padding: '0.6rem 0.75rem', borderRadius: '8px', fontSize: '0.85rem', cursor: 'pointer', fontFamily: "'Inter', sans-serif", outline: 'none' },
            searchStatus: { background: 'rgba(16,185,129,0.08)', border: '1px solid rgba(16,185,129,0.3)', borderRadius: '8px', padding: '0.85rem', marginBottom: '1.5rem', textAlign: 'center', fontWeight: 500, color: '#34d399', fontSize: '0.9rem' },
            loading: { textAlign: 'center', padding: '2rem' },
            loadingText: { fontFamily: "'Orbitron', sans-serif", fontSize: '1rem', color: '#34d399', animation: 'pulse 1.5s ease-in-out infinite' },
            empty: { textAlign: 'center', padding: '4rem 2rem' },
            emptyTitle: { fontSize: '1.6rem', marginBottom: '0.75rem', color: '#64748b', fontFamily: "'Orbitron', sans-serif" },
            emptyText: { fontSize: '1rem', color: '#94a3b8', marginBottom: '0.5rem' },
            emptySubtext: { fontSize: '0.85rem', color: '#475569' },
            grid: { display: 'grid', gap: '1.25rem' },
            card: {
                background: '#1e293b',
                border: '1px solid #334155',
                borderRadius: '16px',
                padding: '1rem',
                boxShadow: '0 10px 15px -3px rgba(0,0,0,0.2), 0 4px 6px -4px rgba(0,0,0,0.2)',
                display: 'grid',
                gap: '0.75rem',
            },
            cardHeader: { display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start', gap: '1rem' },
            companyName: { fontFamily: "'Orbitron', sans-serif", fontSize: '1.15rem', fontWeight: 700, color: '#f1f5f9', marginBottom: '0.2rem' },
            location: { color: '#64748b', fontSize: '0.85rem' },
            executive: { paddingBottom: '0.5rem', borderBottom: '1px solid #1e293b', fontSize: '0.9rem', color: '#94a3b8' },
            linkedinLink: { marginLeft: '0.75rem', color: '#3b82f6', textDecoration: 'none', fontSize: '0.85rem', fontWeight: 500 },
            details: { display: 'grid', gridTemplateColumns: 'repeat(2, 1fr)', gap: '0.4rem', fontSize: '0.85rem', color: '#cbd5e1' },
            whyNow: { background: 'rgba(239,68,68,0.06)', border: '1px solid rgba(239,68,68,0.2)', borderRadius: '8px', padding: '0.85rem' },
            signals: { background: 'rgba(6,182,212,0.04)', border: '1px solid rgba(6,182,212,0.15)', borderRadius: '8px', padding: '0.85rem' },
            signalList: { listStyle: 'none', marginTop: '0.35rem' },
            signalItem: { marginBottom: '0.35rem', fontSize: '0.85rem', color: '#94a3b8' },
            cardActions: { display: 'flex', gap: '0.5rem', flexWrap: 'wrap', paddingTop: '0.5rem', borderTop: '1px solid #1e293b' },
            actionBtn: {
                fontSize: '0.75rem',
                padding: '0.35rem 0.75rem',
                borderRadius: '6px',
                border: '1px solid #475569',
                background: 'transparent',
                color: '#cbd5e1',
                cursor: 'pointer',
                fontFamily: "'Inter', sans-serif",
                fontWeight: 500,
            },
            emailOptions: { background: 'rgba(16,185,129,0.04)', border: '1px solid rgba(16,185,129,0.15)', borderRadius: '8px', padding: '1rem', display: 'flex', flexDirection: 'column', gap: '0.65rem' },
            emailOptionRow: { display: 'flex', alignItems: 'center', gap: '0.75rem' },
            emailOptionLabel: { fontWeight: 600, fontSize: '0.75rem', color: '#64748b', minWidth: '80px', textTransform: 'uppercase', letterSpacing: '0.03em' },
            modalOverlay: { position: 'fixed', top: 0, left: 0, right: 0, bottom: 0, background: 'rgba(0,0,0,0.75)', backdropFilter: 'blur(4px)', display: 'flex', alignItems: 'center', justifyContent: 'center', zIndex: 1000 },
            modal: { background: '#1e293b', border: '1px solid #334155', borderRadius: '12px', padding: '2rem', maxWidth: '600px', width: '90%', maxHeight: '80vh', overflow: 'auto' },
            modalHeader: { display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '1rem' },
            closeBtn: { background: 'none', border: 'none', color: '#94a3b8', fontSize: '1.3rem', cursor: 'pointer' },
            subjectRow: { display: 'flex', alignItems: 'center', gap: '0.75rem', background: 'rgba(6,182,212,0.08)', border: '1px solid rgba(6,182,212,0.2)', borderRadius: '8px', padding: '0.75rem 1rem', marginBottom: '1rem' },
            subjectLabel: { fontWeight: 700, fontSize: '0.75rem', color: '#22d3ee', textTransform: 'uppercase', flexShrink: 0 },
            subjectText: { fontSize: '0.95rem', fontWeight: 600, flex: 1, color: '#f1f5f9' },
            copySmall: { background: 'none', border: 'none', cursor: 'pointer', fontSize: '1rem', padding: '0.25rem', flexShrink: 0, color: '#94a3b8' },
            emailBody: { background: '#0f172a', padding: '1.5rem', borderRadius: '8px', fontSize: '0.9rem', lineHeight: '1.7', marginBottom: '1rem', fontFamily: "'Inter', -apple-system, sans-serif", color: '#cbd5e1' },
            modalActions: { display: 'flex', gap: '1rem' },
        };

        ReactDOM.render(<Root />, document.getElementById('root'));
    </script>
</body>
</html>
