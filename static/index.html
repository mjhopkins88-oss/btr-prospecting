<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BTR Prospecting Engine - AI-Powered Lead Intelligence</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>‚ö°</text></svg>">
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@500;700;900&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #00ff88;
            --primary-dim: #00cc6a;
            --bg-dark: #0a0e1a;
            --bg-card: #151b2e;
            --bg-card-hover: #1a2236;
            --text-primary: #e8eef7;
            --text-secondary: #8b95ab;
            --border: #1f2937;
            --accent-red: #ff4757;
            --accent-blue: #00d4ff;
            --accent-yellow: #ffd93d;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'JetBrains Mono', monospace;
            background: var(--bg-dark);
            color: var(--text-primary);
            line-height: 1.6;
            overflow-x: hidden;
        }
        
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                linear-gradient(90deg, rgba(0, 255, 136, 0.03) 1px, transparent 1px),
                linear-gradient(rgba(0, 255, 136, 0.03) 1px, transparent 1px);
            background-size: 50px 50px;
            animation: gridMove 20s linear infinite;
            pointer-events: none;
            z-index: 0;
        }
        
        @keyframes gridMove {
            0% { transform: translate(0, 0); }
            100% { transform: translate(50px, 50px); }
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }
        
        #root {
            position: relative;
            z-index: 1;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        // Get API base URL (works both locally and on Railway)
        const API_BASE = window.location.hostname === 'localhost' 
            ? 'http://localhost:5000'
            : window.location.origin;

        function App() {
            const [activeTab, setActiveTab] = useState('search');
            const [prospects, setProspects] = useState([]);
            const [loading, setLoading] = useState(false);
            const [selectedProspect, setSelectedProspect] = useState(null);
            const [searchCity, setSearchCity] = useState('Texas');
            const [filterScore, setFilterScore] = useState('all');
            const [emailTemplate, setEmailTemplate] = useState({ subject: '', body: '' });
            const [showEmailModal, setShowEmailModal] = useState(false);
            const [searchStatus, setSearchStatus] = useState('');
            const [cooldown, setCooldown] = useState(0);

            // Load prospects from backend on mount
            useEffect(() => {
                loadProspects();
            }, []);

            // Cooldown timer to prevent rapid-fire searches
            useEffect(() => {
                if (cooldown <= 0) return;
                const timer = setTimeout(() => setCooldown(cooldown - 1), 1000);
                return () => clearTimeout(timer);
            }, [cooldown]);

            const loadProspects = async () => {
                try {
                    const response = await fetch(`${API_BASE}/api/prospects`);
                    const data = await response.json();
                    if (data.success) {
                        setProspects(data.prospects);
                    }
                } catch (error) {
                    console.error('Error loading prospects:', error);
                }
            };

            const searchProspects = async () => {
                if (cooldown > 0) return;
                setLoading(true);
                setSearchStatus('ü§ñ AI is searching the web for BTR prospects...');
                setCooldown(30); // 30-second cooldown between searches

                try {
                    const response = await fetch(`${API_BASE}/api/search`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            city: searchCity,
                            limit: 10
                        })
                    });

                    const data = await response.json();

                    if (data.success) {
                        setSearchStatus(`‚úÖ Found ${data.prospects.length} prospects! ${data.savedCount} new ones added.`);
                        await loadProspects();
                        setTimeout(() => setSearchStatus(''), 3000);
                    } else {
                        // If rate limited but server returned cached DB results, show them
                        if (data.prospects && data.prospects.length > 0) {
                            setProspects(data.prospects);
                            setSearchStatus(`‚ö†Ô∏è ${data.message} ‚Äî Showing ${data.prospects.length} saved prospects.`);
                        } else {
                            setSearchStatus(`‚ùå ${data.message}`);
                        }
                        setTimeout(() => setSearchStatus(''), 8000);
                    }
                } catch (error) {
                    console.error('Search error:', error);
                    setSearchStatus('‚ùå Search failed. Check your internet connection and API key.');
                    setTimeout(() => setSearchStatus(''), 5000);
                } finally {
                    setLoading(false);
                }
            };

            const generateEmail = async (prospect, options = {}) => {
                setLoading(true);
                setSearchStatus('‚úçÔ∏è AI is writing a personalized email...');

                // 30-second timeout
                const controller = new AbortController();
                const timeout = setTimeout(() => controller.abort(), 30000);

                try {
                    const response = await fetch(`${API_BASE}/api/email/generate`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            prospect: prospect,
                            emailPurpose: options.emailPurpose || 'cold_outreach',
                            tone: options.tone || 'professional_direct',
                            offer: options.offer || '15_min_call',
                            triggerEvent: options.triggerEvent || ''
                        }),
                        signal: controller.signal
                    });

                    clearTimeout(timeout);

                    const text = await response.text();
                    let data;
                    try {
                        data = JSON.parse(text);
                    } catch (e) {
                        console.error('Email response not JSON:', text.substring(0, 200));
                        setSearchStatus('‚ùå Email generation returned an invalid response. Try again.');
                        setTimeout(() => setSearchStatus(''), 5000);
                        return;
                    }

                    if (data.success) {
                        const subject = data.subject || '';
                        const body = data.body || data.email || 'No email body returned. Try again.';
                        setSelectedProspect(prospect);
                        setEmailTemplate({ subject, body });
                        setShowEmailModal(true);
                        setSearchStatus('');
                    } else {
                        setSearchStatus(`‚ùå ${data.message || 'Email generation failed.'}`);
                        setTimeout(() => setSearchStatus(''), 5000);
                    }
                } catch (error) {
                    clearTimeout(timeout);
                    console.error('Email generation error:', error);
                    if (error.name === 'AbortError') {
                        setSearchStatus('‚ùå Email generation timed out. Try again.');
                    } else {
                        setSearchStatus(`‚ùå Email generation failed: ${error.message}`);
                    }
                    setTimeout(() => setSearchStatus(''), 5000);
                } finally {
                    setLoading(false);
                }
            };

            const exportToCSV = async () => {
                try {
                    const response = await fetch(`${API_BASE}/api/export`);
                    if (response.ok) {
                        const blob = await response.blob();
                        const url = URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = `btr-prospects-master-${new Date().toISOString().split('T')[0]}.csv`;
                        a.click();
                        URL.revokeObjectURL(url);
                        setSearchStatus(`‚úÖ Master spreadsheet downloaded (${prospects.length} prospects)`);
                        setTimeout(() => setSearchStatus(''), 3000);
                    } else {
                        const data = await response.json();
                        setSearchStatus(`‚ùå ${data.message || 'Export failed'}`);
                        setTimeout(() => setSearchStatus(''), 5000);
                    }
                } catch (error) {
                    console.error('Export error:', error);
                    setSearchStatus('‚ùå Export failed. Try again.');
                    setTimeout(() => setSearchStatus(''), 5000);
                }
            };

            const deleteProspect = async (prospectId) => {
                if (!confirm('Delete this prospect?')) return;
                
                try {
                    await fetch(`${API_BASE}/api/prospects/${prospectId}`, {
                        method: 'DELETE'
                    });
                    await loadProspects();
                } catch (error) {
                    console.error('Delete error:', error);
                }
            };

            const filteredProspects = prospects.filter(p => {
                if (searchCity !== 'all' && searchCity !== 'Texas' && !p.city?.toLowerCase().includes(searchCity.toLowerCase())) return false;
                if (filterScore === '90+' && p.score < 90) return false;
                if (filterScore === '80-89' && (p.score < 80 || p.score >= 90)) return false;
                return true;
            });

            return (
                <div style={styles.container}>
                    <Header />
                    <TabBar activeTab={activeTab} setActiveTab={setActiveTab} />
                    {activeTab === 'search' && (
                        <React.Fragment>
                            <Stats prospects={prospects} />
                            <Controls
                                searchCity={searchCity}
                                setSearchCity={setSearchCity}
                                filterScore={filterScore}
                                setFilterScore={setFilterScore}
                                onSearch={searchProspects}
                                onExport={exportToCSV}
                                loading={loading}
                                hasProspects={prospects.length > 0}
                                cooldown={cooldown}
                            />
                            {searchStatus && <SearchStatus message={searchStatus} />}
                            {loading && <Loading />}
                            <ProspectsList
                                prospects={filteredProspects}
                                onGenerateEmail={generateEmail}
                                onDelete={deleteProspect}
                            />
                        </React.Fragment>
                    )}
                    {activeTab === 'discovery' && <DailyDiscovery />}
                    {showEmailModal && (
                        <EmailModal
                            email={emailTemplate}
                            prospect={selectedProspect}
                            onClose={() => setShowEmailModal(false)}
                        />
                    )}
                </div>
            );
        }

        function Header() {
            return (
                <div style={styles.header}>
                    <h1 style={styles.title}>‚ö° BTR PROSPECTING ENGINE</h1>
                    <p style={styles.subtitle}>AI-Powered Lead Intelligence System</p>
                </div>
            );
        }

        function TabBar({ activeTab, setActiveTab }) {
            const tabs = [
                { id: 'search', label: 'Prospect Search', icon: 'üîç' },
                { id: 'discovery', label: 'Daily Discovery', icon: 'üì°' },
            ];
            return (
                <div style={ds.tabBar}>
                    {tabs.map(tab => (
                        <button
                            key={tab.id}
                            style={{
                                ...ds.tab,
                                ...(activeTab === tab.id ? ds.tabActive : {})
                            }}
                            onClick={() => setActiveTab(tab.id)}
                        >
                            {tab.icon} {tab.label}
                        </button>
                    ))}
                </div>
            );
        }

        function Stats({ prospects }) {
            const avgScore = prospects.length > 0
                ? Math.round(prospects.reduce((sum, p) => sum + p.score, 0) / prospects.length)
                : 0;
            const hotLeads = prospects.filter(p => p.score >= 90).length;
            const hasData = prospects.length > 0;

            return (
                <div style={styles.statsBar}>
                    <StatCard label="Total Prospects" value={hasData ? prospects.length : '--'} />
                    <StatCard label="Hot Leads (90+)" value={hasData ? hotLeads : '--'} pulse={hasData && hotLeads > 0} />
                    <StatCard label="Avg Score" value={hasData ? avgScore : '--'} />
                    <StatCard label="Status" value="LIVE" />
                </div>
            );
        }

        function StatCard({ label, value, pulse }) {
            const displayValue = String(value);
            return (
                <div style={styles.statCard}>
                    <div style={styles.statLabel}>{label}</div>
                    <div style={{...styles.statValue, ...(pulse ? styles.pulse : {})}}>{displayValue}</div>
                </div>
            );
        }

        function Controls({ searchCity, setSearchCity, filterScore, setFilterScore, onSearch, onExport, loading, hasProspects, cooldown }) {
            const isDisabled = loading || cooldown > 0;
            let btnLabel = 'üöÄ Search for Prospects';
            if (loading) btnLabel = 'üîç Searching...';
            else if (cooldown > 0) btnLabel = `‚è≥ Wait ${cooldown}s`;

            return (
                <div style={styles.controls}>
                    <button
                        style={{...styles.btnPrimary, ...(isDisabled ? {opacity: 0.6, cursor: 'not-allowed'} : {})}}
                        onClick={onSearch}
                        disabled={isDisabled}
                    >
                        {btnLabel}
                    </button>
                    <input
                        type="text"
                        style={styles.input}
                        value={searchCity}
                        onChange={(e) => setSearchCity(e.target.value)}
                        placeholder="City or State (e.g., Dallas, Texas, Arizona)"
                    />
                    <select 
                        style={styles.select}
                        value={filterScore}
                        onChange={(e) => setFilterScore(e.target.value)}
                    >
                        <option value="all">All Scores</option>
                        <option value="90+">90+ (Urgent)</option>
                        <option value="80-89">80-89 (High)</option>
                    </select>
                    {hasProspects && (
                        <button style={styles.btn} onClick={onExport}>
                            üì• Download Master Spreadsheet
                        </button>
                    )}
                </div>
            );
        }

        function SearchStatus({ message }) {
            return (
                <div style={styles.searchStatus}>
                    <p>{message}</p>
                </div>
            );
        }

        function Loading() {
            return (
                <div style={styles.loading}>
                    <div style={styles.loadingText}>Processing...</div>
                </div>
            );
        }

        function ProspectsList({ prospects, onGenerateEmail, onDelete }) {
            if (prospects.length === 0) {
                return (
                    <div style={styles.empty}>
                        <h2 style={styles.emptyTitle}>No prospects yet</h2>
                        <p style={styles.emptyText}>Click "Search for Prospects" to find BTR developers using AI</p>
                        <p style={styles.emptySubtext}>The AI will search the web for active BTR developers, executives, and project details</p>
                    </div>
                );
            }

            return (
                <div style={styles.grid}>
                    {prospects.map((prospect) => (
                        <ProspectCard 
                            key={prospect.id} 
                            prospect={prospect}
                            onGenerateEmail={onGenerateEmail}
                            onDelete={onDelete}
                        />
                    ))}
                </div>
            );
        }

        function ProspectCard({ prospect, onGenerateEmail, onDelete }) {
            const [showEmailOptions, setShowEmailOptions] = useState(false);
            const [emailPurpose, setEmailPurpose] = useState('cold_outreach');
            const [tone, setTone] = useState('professional_direct');
            const [offer, setOffer] = useState('15_min_call');

            const foundDate = prospect.createdAt
                ? new Date(prospect.createdAt).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })
                : null;

            const handleGenerate = () => {
                onGenerateEmail(prospect, { emailPurpose, tone, offer });
                setShowEmailOptions(false);
            };

            return (
                <div style={styles.card}>
                    <div style={styles.cardHeader}>
                        <div>
                            <h3 style={styles.companyName}>{prospect.company}</h3>
                            <p style={styles.location}>{prospect.city}, {prospect.state}{foundDate ? ` ¬∑ Found ${foundDate}` : ''}</p>
                        </div>
                        <div style={styles.scoreBadge}>{prospect.score}</div>
                    </div>
                    <div style={styles.executive}>
                        <strong>{prospect.executive || 'Contact via company'}</strong> {prospect.title && `- ${prospect.title}`}
                        {prospect.linkedin && (
                            <a
                                href={`https://${prospect.linkedin}`}
                                target="_blank"
                                style={styles.linkedinLink}
                            >
                                üîó LinkedIn
                            </a>
                        )}
                    </div>
                    <div style={styles.details}>
                        <div><strong>Project:</strong> {prospect.projectName}</div>
                        <div><strong>Status:</strong> {prospect.projectStatus}</div>
                        <div><strong>Size:</strong> {prospect.units}</div>
                        <div><strong>TIV:</strong> {prospect.tiv}</div>
                    </div>
                    <div style={styles.whyNow}>
                        <strong>üî• Why Call NOW:</strong>
                        <p>{prospect.whyNow}</p>
                    </div>
                    {prospect.signals && prospect.signals.length > 0 && (
                        <div style={styles.signals}>
                            <strong>‚ö° Signals:</strong>
                            <ul style={styles.signalList}>
                                {prospect.signals.map((signal, idx) => (
                                    <li key={idx} style={styles.signalItem}>‚ñ∏ {signal}</li>
                                ))}
                            </ul>
                        </div>
                    )}

                    {showEmailOptions && (
                        <div style={styles.emailOptions}>
                            <div style={styles.emailOptionRow}>
                                <label style={styles.emailOptionLabel}>Purpose</label>
                                <select style={styles.select} value={emailPurpose} onChange={e => setEmailPurpose(e.target.value)}>
                                    <option value="cold_outreach">Cold Outreach</option>
                                    <option value="follow_up">Follow Up</option>
                                    <option value="event_invite">Event Invite</option>
                                    <option value="post_event_follow_up">Post-Event Follow Up</option>
                                    <option value="referral_intro">Referral Intro</option>
                                    <option value="renewal_quote_follow_up">Renewal/Quote Follow Up</option>
                                </select>
                            </div>
                            <div style={styles.emailOptionRow}>
                                <label style={styles.emailOptionLabel}>Tone</label>
                                <select style={styles.select} value={tone} onChange={e => setTone(e.target.value)}>
                                    <option value="professional_direct">Professional Direct</option>
                                    <option value="strategic_exec">Strategic Exec</option>
                                    <option value="conversational">Conversational</option>
                                    <option value="friendly">Friendly</option>
                                    <option value="urgent_light">Urgent (Light)</option>
                                </select>
                            </div>
                            <div style={styles.emailOptionRow}>
                                <label style={styles.emailOptionLabel}>CTA / Offer</label>
                                <select style={styles.select} value={offer} onChange={e => setOffer(e.target.value)}>
                                    <option value="15_min_call">15-Min Call</option>
                                    <option value="share_resource">Share a Resource</option>
                                    <option value="quick_question">Quick Question</option>
                                </select>
                            </div>
                            <button style={styles.btnPrimary} onClick={handleGenerate}>
                                ‚úçÔ∏è Generate Now
                            </button>
                        </div>
                    )}

                    <div style={styles.cardActions}>
                        <button
                            style={styles.emailBtn}
                            onClick={() => setShowEmailOptions(!showEmailOptions)}
                        >
                            {showEmailOptions ? '‚úï Cancel' : '‚úâÔ∏è Generate Email'}
                        </button>
                        <button
                            style={styles.deleteBtn}
                            onClick={() => onDelete(prospect.id)}
                        >
                            üóëÔ∏è
                        </button>
                    </div>
                </div>
            );
        }

        function EmailModal({ email, prospect, onClose }) {
            const subject = email.subject || '';
            const body = email.body || email || '';
            const fullText = subject ? `Subject: ${subject}\n\n${body}` : body;

            const copyEmail = () => {
                navigator.clipboard.writeText(fullText);
                alert('Email copied to clipboard!');
            };

            const copySubject = () => {
                navigator.clipboard.writeText(subject);
                alert('Subject line copied!');
            };

            return (
                <div style={styles.modalOverlay} onClick={onClose}>
                    <div style={styles.modal} onClick={(e) => e.stopPropagation()}>
                        <div style={styles.modalHeader}>
                            <h2>Email for {prospect.company}</h2>
                            <button style={styles.closeBtn} onClick={onClose}>‚úï</button>
                        </div>
                        {subject && (
                            <div style={styles.subjectRow}>
                                <span style={styles.subjectLabel}>SUBJECT:</span>
                                <span style={styles.subjectText}>{subject}</span>
                                <button style={styles.copySmall} onClick={copySubject} title="Copy subject">üìã</button>
                            </div>
                        )}
                        <div style={styles.emailBody}>
                            {body.split('\n').map((line, i) => (
                                <React.Fragment key={i}>{line}<br/></React.Fragment>
                            ))}
                        </div>
                        <div style={styles.modalActions}>
                            <button style={styles.btnPrimary} onClick={copyEmail}>
                                üìã Copy Full Email
                            </button>
                            <button style={styles.btn} onClick={onClose}>Close</button>
                        </div>
                    </div>
                </div>
            );
        }

        function DailyDiscovery() {
            const [config, setConfig] = useState(null);
            const [latestRun, setLatestRun] = useState(null);
            const [selectedRun, setSelectedRun] = useState(null);
            const [history, setHistory] = useState([]);
            const [running, setRunning] = useState(false);
            const [status, setStatus] = useState('');
            const [showDigest, setShowDigest] = useState(false);

            useEffect(() => {
                loadConfig();
                loadLatest();
                loadHistory();
                checkStatus();
            }, []);

            // Poll when running
            useEffect(() => {
                if (!running) return;
                const interval = setInterval(async () => {
                    try {
                        const res = await fetch(`${API_BASE}/api/discovery/status`);
                        const data = await res.json();
                        if (!data.running) {
                            setRunning(false);
                            setStatus('Discovery complete!');
                            loadLatest();
                            loadHistory();
                            setTimeout(() => setStatus(''), 5000);
                        }
                    } catch (e) { console.error('Poll error:', e); }
                }, 5000);
                return () => clearInterval(interval);
            }, [running]);

            const loadConfig = async () => {
                try {
                    const res = await fetch(`${API_BASE}/api/discovery/config`);
                    const data = await res.json();
                    if (data.success) setConfig(data.config);
                } catch (e) { console.error('Config load error:', e); }
            };

            const loadLatest = async () => {
                try {
                    const res = await fetch(`${API_BASE}/api/discovery/latest`);
                    const data = await res.json();
                    if (data.success && data.run) {
                        setLatestRun(data.run);
                        setSelectedRun(data.run);
                    }
                } catch (e) { console.error('Latest load error:', e); }
            };

            const loadHistory = async () => {
                try {
                    const res = await fetch(`${API_BASE}/api/discovery/history`);
                    const data = await res.json();
                    if (data.success) setHistory(data.runs);
                } catch (e) { console.error('History load error:', e); }
            };

            const checkStatus = async () => {
                try {
                    const res = await fetch(`${API_BASE}/api/discovery/status`);
                    const data = await res.json();
                    if (data.running) { setRunning(true); setStatus('Discovery is running...'); }
                } catch (e) { console.error('Status check error:', e); }
            };

            const triggerRun = async () => {
                try {
                    setRunning(true);
                    setStatus('Starting discovery run across all cities...');
                    const res = await fetch(`${API_BASE}/api/discovery/run`, { method: 'POST' });
                    const data = await res.json();
                    if (!data.success) {
                        setRunning(false);
                        setStatus(data.message);
                        setTimeout(() => setStatus(''), 5000);
                    } else {
                        setStatus('Discovery is running ‚Äî searching 6 cities...');
                    }
                } catch (e) {
                    setRunning(false);
                    setStatus('Failed to start discovery.');
                    setTimeout(() => setStatus(''), 5000);
                }
            };

            const loadRunDetail = async (runId) => {
                try {
                    const res = await fetch(`${API_BASE}/api/discovery/run/${runId}`);
                    const data = await res.json();
                    if (data.success) setSelectedRun(data.run);
                } catch (e) { console.error('Run detail error:', e); }
            };

            const renderStars = (rating) => {
                const full = Math.floor(rating);
                const half = rating % 1 >= 0.5;
                let stars = '';
                for (let i = 0; i < full; i++) stars += '\u2605';
                if (half) stars += '\u00BD';
                return stars;
            };

            if (!config) return <div style={ds.loadingMsg}>Loading configuration...</div>;

            const results = selectedRun?.results || {};

            return (
                <div>
                    {/* Config Panel */}
                    <div style={ds.configPanel}>
                        <div style={ds.configHeader}>
                            <h2 style={ds.sectionTitle}>Daily Discovery</h2>
                            <div style={ds.schedule}>
                                Runs daily at {config.schedule_hour}:{String(config.schedule_minute).padStart(2, '0')} AM PT
                            </div>
                        </div>
                        <div style={ds.configGrid}>
                            <div>
                                <div style={ds.configLabel}>Target Cities</div>
                                <div style={ds.chipGroup}>
                                    {config.cities.map((c, i) => (
                                        <span key={i} style={ds.chip}>{c.city}, {c.state}</span>
                                    ))}
                                </div>
                            </div>
                            <div>
                                <div style={ds.configLabel}>ICP Keywords</div>
                                <div style={ds.chipGroup}>
                                    {config.icp_keywords.map((kw, i) => (
                                        <span key={i} style={ds.keywordChip}>{kw}</span>
                                    ))}
                                </div>
                            </div>
                            {config.target_sources && config.target_sources.length > 0 && (
                                <div>
                                    <div style={ds.configLabel}>Target Sources</div>
                                    <div style={ds.chipGroup}>
                                        {config.target_sources.map((src, i) => (
                                            <span key={i} style={ds.sourceChip}>{src}</span>
                                        ))}
                                    </div>
                                </div>
                            )}
                            {config.monitor_operators && config.monitor_operators.length > 0 && (
                                <div>
                                    <div style={ds.configLabel}>Monitored Operators</div>
                                    <div style={ds.chipGroup}>
                                        {config.monitor_operators.map((op, i) => (
                                            <span key={i} style={ds.operatorChip}>{op}</span>
                                        ))}
                                    </div>
                                </div>
                            )}
                            <div>
                                <div style={ds.configLabel}>Filters</div>
                                <div style={ds.filterRow}>
                                    <span style={ds.filterItem}>Min Rating: {config.min_rating}\u2605</span>
                                    <span style={ds.filterItem}>Min Reviews: {config.min_reviews}</span>
                                    <span style={ds.filterItem}>Top {config.top_n_per_city} per city</span>
                                    <span style={ds.filterItem}>Delivery: {config.delivery_method}</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    {/* Action Bar */}
                    <div style={ds.actionBar}>
                        <button
                            style={{...styles.btnPrimary, ...(running ? {opacity: 0.6, cursor: 'not-allowed'} : {}), fontSize: '1rem', padding: '0.85rem 2rem'}}
                            onClick={triggerRun}
                            disabled={running}
                        >
                            {running ? 'üîç Running Discovery...' : 'üöÄ Run Discovery Now'}
                        </button>
                        {selectedRun && (
                            <button
                                style={{...styles.btn, fontSize: '0.9rem'}}
                                onClick={() => setShowDigest(!showDigest)}
                            >
                                {showDigest ? 'üìä Show Cards' : 'üìù Show Digest'}
                            </button>
                        )}
                        {latestRun && (
                            <span style={ds.lastRun}>
                                Last run: {new Date(latestRun.run_at).toLocaleString()} &middot; {latestRun.total_new} new
                            </span>
                        )}
                    </div>

                    {status && (
                        <div style={styles.searchStatus}><p>{status}</p></div>
                    )}
                    {running && (
                        <div style={styles.loading}>
                            <div style={styles.loadingText}>Searching business directories...</div>
                        </div>
                    )}

                    {/* Digest View */}
                    {showDigest && selectedRun?.digest && (
                        <div style={ds.digestBox}>
                            <pre style={ds.digestText}>{selectedRun.digest}</pre>
                        </div>
                    )}

                    {/* Results by City */}
                    {!showDigest && selectedRun && (
                        <div>
                            {Object.entries(results).map(([location, data]) => (
                                <div key={location} style={ds.citySection}>
                                    <div style={ds.cityHeader}>
                                        <h3 style={ds.cityTitle}>{location}</h3>
                                        {data.new_count !== undefined && (
                                            <span style={ds.newBadge}>{data.new_count} new</span>
                                        )}
                                    </div>
                                    {data.error && <p style={ds.errorText}>Error: {data.error}</p>}
                                    {!data.error && (!data.businesses || data.businesses.length === 0) && (
                                        <p style={ds.noResults}>No new businesses found</p>
                                    )}
                                    <div style={ds.businessGrid}>
                                        {(data.businesses || []).map((b, i) => (
                                            <div key={i} style={ds.businessCard}>
                                                <div style={ds.businessHeader}>
                                                    <h4 style={ds.businessName}>{b.name}</h4>
                                                    <div style={ds.ratingBadge}>
                                                        <span style={ds.stars}>{renderStars(b.rating)}</span>
                                                        <span style={ds.ratingNum}>{b.rating}</span>
                                                    </div>
                                                </div>
                                                <div style={ds.reviewCount}>{b.review_count} reviews</div>
                                                <div style={ds.businessCategory}>{b.category}</div>
                                                {b.address && <div style={ds.businessDetail}>{b.address}</div>}
                                                {b.phone && <div style={ds.businessDetail}>{b.phone}</div>}
                                                {b.website && (
                                                    <a
                                                        href={b.website.startsWith('http') ? b.website : `https://${b.website}`}
                                                        target="_blank"
                                                        rel="noopener noreferrer"
                                                        style={ds.websiteLink}
                                                    >
                                                        üîó Website
                                                    </a>
                                                )}
                                                <div style={ds.icpMatch}>ICP: {b.icp_match}</div>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            ))}
                        </div>
                    )}

                    {/* Empty state */}
                    {!selectedRun && !running && (
                        <div style={styles.empty}>
                            <h2 style={styles.emptyTitle}>No discovery runs yet</h2>
                            <p style={styles.emptyText}>Click "Run Discovery Now" to search business directories across all 6 cities</p>
                            <p style={styles.emptySubtext}>The AI will search Bisnow, Multi-Housing News, BizJournals, LinkedIn and other CRE sources for BTR companies</p>
                        </div>
                    )}

                    {/* Run History */}
                    {history.length > 0 && (
                        <div style={ds.historySection}>
                            <h3 style={ds.sectionTitle}>Run History</h3>
                            <div style={ds.historyList}>
                                {history.map(run => (
                                    <div
                                        key={run.id}
                                        style={{...ds.historyItem, ...(selectedRun?.id === run.id ? ds.historyItemActive : {})}}
                                        onClick={() => loadRunDetail(run.id)}
                                    >
                                        <span style={ds.historyDate}>{new Date(run.run_at).toLocaleString()}</span>
                                        <span style={ds.historyStats}>{run.total_new} new &middot; {run.city_count} cities</span>
                                        <span style={{...ds.historyStatus, color: run.status === 'completed' ? '#00ff88' : '#ffd93d'}}>{run.status}</span>
                                    </div>
                                ))}
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        // Discovery-specific styles
        const ds = {
            tabBar: { display: 'flex', gap: '0.25rem', marginBottom: '2rem', borderBottom: '2px solid #1f2937', paddingBottom: '0' },
            tab: { background: 'transparent', border: 'none', color: '#8b95ab', padding: '0.75rem 1.5rem', fontSize: '1rem', fontWeight: 600, cursor: 'pointer', borderBottom: '2px solid transparent', marginBottom: '-2px', fontFamily: 'Orbitron, sans-serif', transition: 'color 0.2s, border-color 0.2s' },
            tabActive: { color: '#00ff88', borderBottomColor: '#00ff88' },
            loadingMsg: { textAlign: 'center', padding: '3rem', color: '#8b95ab' },
            configPanel: { background: '#151b2e', border: '1px solid #1f2937', borderRadius: '12px', padding: '1.5rem', marginBottom: '2rem' },
            configHeader: { display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '1rem', flexWrap: 'wrap', gap: '0.5rem' },
            sectionTitle: { fontFamily: 'Orbitron, sans-serif', fontSize: '1.3rem', fontWeight: 700, color: '#00ff88' },
            schedule: { color: '#8b95ab', fontSize: '0.9rem' },
            configGrid: { display: 'grid', gap: '1rem' },
            configLabel: { fontSize: '0.8rem', color: '#8b95ab', textTransform: 'uppercase', fontWeight: 600, marginBottom: '0.5rem' },
            chipGroup: { display: 'flex', flexWrap: 'wrap', gap: '0.5rem' },
            chip: { background: 'rgba(0, 255, 136, 0.1)', border: '1px solid rgba(0, 255, 136, 0.3)', borderRadius: '20px', padding: '0.3rem 0.8rem', fontSize: '0.85rem', color: '#00ff88' },
            keywordChip: { background: 'rgba(0, 212, 255, 0.1)', border: '1px solid rgba(0, 212, 255, 0.2)', borderRadius: '20px', padding: '0.3rem 0.8rem', fontSize: '0.8rem', color: '#00d4ff' },
            sourceChip: { background: 'rgba(255, 217, 61, 0.1)', border: '1px solid rgba(255, 217, 61, 0.3)', borderRadius: '20px', padding: '0.3rem 0.8rem', fontSize: '0.8rem', color: '#ffd93d' },
            operatorChip: { background: 'rgba(255, 71, 87, 0.1)', border: '1px solid rgba(255, 71, 87, 0.3)', borderRadius: '20px', padding: '0.3rem 0.8rem', fontSize: '0.8rem', color: '#ff4757' },
            filterRow: { display: 'flex', gap: '1.5rem', flexWrap: 'wrap' },
            filterItem: { color: '#e8eef7', fontSize: '0.9rem' },
            actionBar: { display: 'flex', gap: '1rem', alignItems: 'center', marginBottom: '2rem', flexWrap: 'wrap' },
            lastRun: { color: '#8b95ab', fontSize: '0.85rem' },
            digestBox: { background: '#0a0e1a', border: '1px solid #1f2937', borderRadius: '12px', padding: '1.5rem', marginBottom: '2rem', overflow: 'auto', maxHeight: '600px' },
            digestText: { fontFamily: 'JetBrains Mono, monospace', fontSize: '0.85rem', color: '#e8eef7', whiteSpace: 'pre-wrap', lineHeight: '1.5', margin: 0 },
            citySection: { marginBottom: '2rem' },
            cityHeader: { display: 'flex', alignItems: 'center', gap: '0.75rem', marginBottom: '1rem', paddingBottom: '0.5rem', borderBottom: '1px solid #1f2937' },
            cityTitle: { fontFamily: 'Orbitron, sans-serif', fontSize: '1.1rem', fontWeight: 700, color: '#00d4ff' },
            newBadge: { background: 'rgba(0, 255, 136, 0.15)', border: '1px solid #00ff88', borderRadius: '12px', padding: '0.15rem 0.6rem', fontSize: '0.75rem', color: '#00ff88', fontWeight: 600 },
            errorText: { color: '#ff4757', fontSize: '0.9rem' },
            noResults: { color: '#8b95ab', fontSize: '0.9rem', fontStyle: 'italic' },
            businessGrid: { display: 'grid', gridTemplateColumns: 'repeat(auto-fill, minmax(320px, 1fr))', gap: '1rem' },
            businessCard: { background: '#151b2e', border: '1px solid #1f2937', borderRadius: '10px', padding: '1.25rem' },
            businessHeader: { display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start', marginBottom: '0.5rem' },
            businessName: { fontFamily: 'Orbitron, sans-serif', fontSize: '1rem', fontWeight: 600, color: '#e8eef7', flex: 1, marginRight: '0.5rem' },
            ratingBadge: { display: 'flex', alignItems: 'center', gap: '0.25rem', flexShrink: 0 },
            stars: { color: '#ffd93d', fontSize: '0.9rem' },
            ratingNum: { color: '#ffd93d', fontWeight: 700, fontSize: '0.9rem' },
            reviewCount: { color: '#8b95ab', fontSize: '0.8rem', marginBottom: '0.5rem' },
            businessCategory: { color: '#00d4ff', fontSize: '0.85rem', marginBottom: '0.75rem', fontWeight: 500 },
            businessDetail: { color: '#8b95ab', fontSize: '0.85rem', marginBottom: '0.25rem' },
            websiteLink: { color: '#00d4ff', textDecoration: 'none', fontSize: '0.85rem', display: 'inline-block', marginTop: '0.5rem' },
            icpMatch: { marginTop: '0.75rem', paddingTop: '0.5rem', borderTop: '1px solid #1f2937', color: '#00ff88', fontSize: '0.8rem', fontStyle: 'italic' },
            historySection: { marginTop: '2rem', background: '#151b2e', border: '1px solid #1f2937', borderRadius: '12px', padding: '1.5rem' },
            historyList: { display: 'flex', flexDirection: 'column', gap: '0.5rem', marginTop: '1rem' },
            historyItem: { display: 'flex', justifyContent: 'space-between', alignItems: 'center', padding: '0.75rem 1rem', borderRadius: '8px', cursor: 'pointer', background: '#0a0e1a', border: '1px solid transparent' },
            historyItemActive: { border: '1px solid #00ff88', background: 'rgba(0, 255, 136, 0.05)' },
            historyDate: { fontSize: '0.85rem', color: '#e8eef7' },
            historyStats: { fontSize: '0.85rem', color: '#8b95ab' },
            historyStatus: { fontSize: '0.8rem', fontWeight: 600, textTransform: 'uppercase' },
        };

        const styles = {
            container: { maxWidth: '1400px', margin: '0 auto', padding: '2rem' },
            header: { marginBottom: '3rem', textAlign: 'center' },
            title: { fontFamily: 'Orbitron, sans-serif', fontSize: '3rem', fontWeight: 900, background: 'linear-gradient(135deg, #00ff88 0%, #00d4ff 100%)', WebkitBackgroundClip: 'text', WebkitTextFillColor: 'transparent', marginBottom: '0.5rem' },
            subtitle: { fontSize: '1.1rem', color: '#8b95ab' },
            statsBar: { display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(200px, 1fr))', gap: '1.5rem', marginBottom: '3rem' },
            statCard: { background: '#151b2e', border: '1px solid #1f2937', borderRadius: '12px', padding: '1.5rem' },
            statLabel: { fontSize: '0.85rem', color: '#8b95ab', textTransform: 'uppercase', marginBottom: '0.5rem' },
            statValue: { fontFamily: "'JetBrains Mono', monospace", fontSize: '2rem', fontWeight: 700, color: '#00ff88', lineHeight: '1.2', display: 'block', minHeight: '2.4rem' },
            pulse: { animation: 'pulse 2s ease-in-out infinite' },
            controls: { display: 'flex', gap: '1rem', marginBottom: '2rem', flexWrap: 'wrap' },
            btn: { background: '#151b2e', border: '1px solid #1f2937', color: '#e8eef7', padding: '0.75rem 1.5rem', borderRadius: '8px', fontSize: '0.9rem', cursor: 'pointer' },
            btnPrimary: { background: '#00ff88', border: 'none', color: '#0a0e1a', padding: '0.75rem 1.5rem', borderRadius: '8px', fontSize: '0.9rem', fontWeight: 600, cursor: 'pointer' },
            input: { background: '#151b2e', border: '1px solid #1f2937', color: '#e8eef7', padding: '0.75rem 1rem', borderRadius: '8px', fontSize: '0.9rem', minWidth: '250px' },
            select: { background: '#151b2e', border: '1px solid #1f2937', color: '#e8eef7', padding: '0.75rem 1rem', borderRadius: '8px', fontSize: '0.9rem', cursor: 'pointer' },
            searchStatus: { background: 'rgba(0, 255, 136, 0.1)', border: '1px solid #00ff88', borderRadius: '8px', padding: '1rem', marginBottom: '2rem', textAlign: 'center', fontWeight: 600 },
            loading: { textAlign: 'center', padding: '3rem' },
            loadingText: { fontFamily: 'Orbitron, sans-serif', fontSize: '1.2rem', color: '#00ff88', animation: 'pulse 1.5s ease-in-out infinite' },
            empty: { textAlign: 'center', padding: '4rem' },
            emptyTitle: { fontSize: '2rem', marginBottom: '1rem', color: '#8b95ab' },
            emptyText: { fontSize: '1.1rem', color: '#8b95ab', marginBottom: '0.5rem' },
            emptySubtext: { fontSize: '0.9rem', color: '#6b7589' },
            grid: { display: 'grid', gap: '1.5rem' },
            card: { background: '#151b2e', border: '1px solid #1f2937', borderRadius: '12px', padding: '1.5rem' },
            cardHeader: { display: 'flex', justifyContent: 'space-between', marginBottom: '1rem' },
            companyName: { fontFamily: 'Orbitron, sans-serif', fontSize: '1.3rem', fontWeight: 700, marginBottom: '0.25rem' },
            location: { color: '#8b95ab', fontSize: '0.9rem' },
            scoreBadge: { background: 'linear-gradient(135deg, #00ff88, #00d4ff)', color: '#0a0e1a', padding: '0.5rem 1rem', borderRadius: '20px', fontFamily: 'Orbitron, sans-serif', fontWeight: 700, fontSize: '1.1rem' },
            executive: { marginBottom: '1rem', paddingBottom: '1rem', borderBottom: '1px solid #1f2937' },
            linkedinLink: { marginLeft: '1rem', color: '#00d4ff', textDecoration: 'none', fontSize: '0.9rem' },
            details: { display: 'grid', gridTemplateColumns: 'repeat(2, 1fr)', gap: '0.5rem', marginBottom: '1rem', fontSize: '0.9rem' },
            whyNow: { background: 'rgba(255, 71, 87, 0.1)', border: '1px solid #ff4757', borderRadius: '8px', padding: '1rem', marginBottom: '1rem' },
            signals: { background: 'rgba(0, 212, 255, 0.05)', border: '1px solid rgba(0, 212, 255, 0.2)', borderRadius: '8px', padding: '1rem', marginBottom: '1rem' },
            signalList: { listStyle: 'none', marginTop: '0.5rem' },
            signalItem: { marginBottom: '0.5rem' },
            cardActions: { display: 'flex', gap: '0.5rem' },
            emailBtn: { flex: 1, background: '#00ff88', border: 'none', color: '#0a0e1a', padding: '0.75rem', borderRadius: '8px', fontWeight: 600, cursor: 'pointer', fontSize: '1rem' },
            deleteBtn: { background: '#ff4757', border: 'none', color: '#fff', padding: '0.75rem 1rem', borderRadius: '8px', cursor: 'pointer', fontSize: '1rem' },
            modalOverlay: { position: 'fixed', top: 0, left: 0, right: 0, bottom: 0, background: 'rgba(0, 0, 0, 0.8)', display: 'flex', alignItems: 'center', justifyContent: 'center', zIndex: 1000 },
            modal: { background: '#151b2e', border: '1px solid #1f2937', borderRadius: '12px', padding: '2rem', maxWidth: '600px', width: '90%', maxHeight: '80vh', overflow: 'auto' },
            modalHeader: { display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '1rem' },
            closeBtn: { background: 'none', border: 'none', color: '#e8eef7', fontSize: '1.5rem', cursor: 'pointer' },
            emailText: { background: '#0a0e1a', padding: '1.5rem', borderRadius: '8px', whiteSpace: 'pre-wrap', fontFamily: 'JetBrains Mono, monospace', fontSize: '0.9rem', lineHeight: '1.6', marginBottom: '1rem' },
            modalActions: { display: 'flex', gap: '1rem' },
            emailOptions: { background: 'rgba(0, 255, 136, 0.05)', border: '1px solid rgba(0, 255, 136, 0.2)', borderRadius: '8px', padding: '1rem', marginBottom: '1rem', display: 'flex', flexDirection: 'column', gap: '0.75rem' },
            emailOptionRow: { display: 'flex', alignItems: 'center', gap: '0.75rem' },
            emailOptionLabel: { fontWeight: 600, fontSize: '0.85rem', color: '#8b95ab', minWidth: '80px', textTransform: 'uppercase' },
            subjectRow: { display: 'flex', alignItems: 'center', gap: '0.75rem', background: 'rgba(0, 212, 255, 0.1)', border: '1px solid rgba(0, 212, 255, 0.3)', borderRadius: '8px', padding: '0.75rem 1rem', marginBottom: '1rem' },
            subjectLabel: { fontWeight: 700, fontSize: '0.8rem', color: '#00d4ff', textTransform: 'uppercase', flexShrink: 0 },
            subjectText: { fontSize: '1rem', fontWeight: 600, flex: 1 },
            copySmall: { background: 'none', border: 'none', cursor: 'pointer', fontSize: '1rem', padding: '0.25rem', flexShrink: 0 },
            emailBody: { background: '#0a0e1a', padding: '1.5rem', borderRadius: '8px', fontSize: '0.95rem', lineHeight: '1.7', marginBottom: '1rem', fontFamily: '-apple-system, BlinkMacSystemFont, sans-serif' }
        };

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>
