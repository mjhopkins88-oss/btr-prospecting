<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BTR Prospecting Engine - AI-Powered Lead Intelligence</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>‚ö°</text></svg>">
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@500;700;900&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #00ff88;
            --primary-dim: #00cc6a;
            --bg-dark: #0a0e1a;
            --bg-card: #151b2e;
            --bg-card-hover: #1a2236;
            --text-primary: #e8eef7;
            --text-secondary: #8b95ab;
            --border: #1f2937;
            --accent-red: #ff4757;
            --accent-blue: #00d4ff;
            --accent-yellow: #ffd93d;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'JetBrains Mono', monospace;
            background: var(--bg-dark);
            color: var(--text-primary);
            line-height: 1.6;
            overflow-x: hidden;
        }
        
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                linear-gradient(90deg, rgba(0, 255, 136, 0.03) 1px, transparent 1px),
                linear-gradient(rgba(0, 255, 136, 0.03) 1px, transparent 1px);
            background-size: 50px 50px;
            animation: gridMove 20s linear infinite;
            pointer-events: none;
            z-index: 0;
        }
        
        @keyframes gridMove {
            0% { transform: translate(0, 0); }
            100% { transform: translate(50px, 50px); }
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }
        
        #root {
            position: relative;
            z-index: 1;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        // Get API base URL (works both locally and on Railway)
        const API_BASE = window.location.hostname === 'localhost' 
            ? 'http://localhost:5000'
            : window.location.origin;

        function App() {
            const [prospects, setProspects] = useState([]);
            const [loading, setLoading] = useState(false);
            const [selectedProspect, setSelectedProspect] = useState(null);
            const [searchCity, setSearchCity] = useState('Texas');
            const [filterScore, setFilterScore] = useState('all');
            const [emailTemplate, setEmailTemplate] = useState('');
            const [showEmailModal, setShowEmailModal] = useState(false);
            const [searchStatus, setSearchStatus] = useState('');

            // Load prospects from backend on mount
            useEffect(() => {
                loadProspects();
            }, []);

            const loadProspects = async () => {
                try {
                    const response = await fetch(`${API_BASE}/api/prospects`);
                    const data = await response.json();
                    if (data.success) {
                        setProspects(data.prospects);
                    }
                } catch (error) {
                    console.error('Error loading prospects:', error);
                }
            };

            const searchProspects = async () => {
                setLoading(true);
                setSearchStatus('ü§ñ AI is searching the web for BTR prospects...');
                
                try {
                    const response = await fetch(`${API_BASE}/api/search`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            city: searchCity,
                            limit: 10
                        })
                    });

                    const data = await response.json();
                    
                    if (data.success) {
                        setSearchStatus(`‚úÖ Found ${data.prospects.length} prospects! ${data.savedCount} new ones added.`);
                        await loadProspects(); // Reload from database
                        setTimeout(() => setSearchStatus(''), 3000);
                    } else {
                        setSearchStatus(`‚ùå ${data.message}`);
                        setTimeout(() => setSearchStatus(''), 5000);
                    }
                } catch (error) {
                    console.error('Search error:', error);
                    setSearchStatus('‚ùå Search failed. Check your internet connection and API key.');
                    setTimeout(() => setSearchStatus(''), 5000);
                } finally {
                    setLoading(false);
                }
            };

            const generateEmail = async (prospect) => {
                setLoading(true);
                setSearchStatus('‚úçÔ∏è AI is writing a personalized email...');
                
                try {
                    const response = await fetch(`${API_BASE}/api/email/generate`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            prospect: prospect
                        })
                    });

                    const data = await response.json();
                    
                    if (data.success) {
                        setEmailTemplate(data.email);
                        setShowEmailModal(true);
                        setSelectedProspect(prospect);
                        setSearchStatus('');
                    } else {
                        setSearchStatus(`‚ùå ${data.message}`);
                        setTimeout(() => setSearchStatus(''), 5000);
                    }
                } catch (error) {
                    console.error('Email generation error:', error);
                    setSearchStatus('‚ùå Email generation failed.');
                    setTimeout(() => setSearchStatus(''), 5000);
                } finally {
                    setLoading(false);
                }
            };

            const exportToCSV = () => {
                const headers = ['Company', 'Executive', 'Title', 'LinkedIn', 'City', 'Score', 'TIV', 'Project', 'Status', 'Why Now'];
                const rows = prospects.map(p => [
                    p.company,
                    p.executive,
                    p.title,
                    p.linkedin,
                    p.city,
                    p.score,
                    p.tiv,
                    p.projectName,
                    p.projectStatus,
                    p.whyNow
                ]);

                const csv = [headers, ...rows].map(row => row.map(cell => `"${cell || ''}"`).join(',')).join('\n');
                const blob = new Blob([csv], { type: 'text/csv' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `btr-prospects-${new Date().toISOString().split('T')[0]}.csv`;
                a.click();
            };

            const deleteProspect = async (prospectId) => {
                if (!confirm('Delete this prospect?')) return;
                
                try {
                    await fetch(`${API_BASE}/api/prospects/${prospectId}`, {
                        method: 'DELETE'
                    });
                    await loadProspects();
                } catch (error) {
                    console.error('Delete error:', error);
                }
            };

            const filteredProspects = prospects.filter(p => {
                if (searchCity !== 'all' && searchCity !== 'Texas' && !p.city?.toLowerCase().includes(searchCity.toLowerCase())) return false;
                if (filterScore === '90+' && p.score < 90) return false;
                if (filterScore === '80-89' && (p.score < 80 || p.score >= 90)) return false;
                return true;
            });

            return (
                <div style={styles.container}>
                    <Header />
                    <Stats prospects={prospects} />
                    <Controls 
                        searchCity={searchCity}
                        setSearchCity={setSearchCity}
                        filterScore={filterScore}
                        setFilterScore={setFilterScore}
                        onSearch={searchProspects}
                        onExport={exportToCSV}
                        loading={loading}
                        hasProspects={prospects.length > 0}
                    />
                    {searchStatus && <SearchStatus message={searchStatus} />}
                    {loading && <Loading />}
                    <ProspectsList 
                        prospects={filteredProspects}
                        onGenerateEmail={generateEmail}
                        onDelete={deleteProspect}
                    />
                    {showEmailModal && (
                        <EmailModal 
                            email={emailTemplate}
                            prospect={selectedProspect}
                            onClose={() => setShowEmailModal(false)}
                        />
                    )}
                </div>
            );
        }

        function Header() {
            return (
                <div style={styles.header}>
                    <h1 style={styles.title}>‚ö° BTR PROSPECTING ENGINE</h1>
                    <p style={styles.subtitle}>AI-Powered Lead Intelligence System</p>
                </div>
            );
        }

        function Stats({ prospects }) {
            const avgScore = prospects.length > 0 
                ? Math.round(prospects.reduce((sum, p) => sum + p.score, 0) / prospects.length)
                : 0;
            const hotLeads = prospects.filter(p => p.score >= 90).length;

            return (
                <div style={styles.statsBar}>
                    <StatCard label="Total Prospects" value={prospects.length} />
                    <StatCard label="Hot Leads (90+)" value={hotLeads} pulse />
                    <StatCard label="Avg Score" value={avgScore} />
                    <StatCard label="Status" value="LIVE" />
                </div>
            );
        }

        function StatCard({ label, value, pulse }) {
            return (
                <div style={styles.statCard}>
                    <div style={styles.statLabel}>{label}</div>
                    <div style={{...styles.statValue, ...(pulse ? styles.pulse : {})}}>{String(value)}</div>
                </div>
            );
        }

        function Controls({ searchCity, setSearchCity, filterScore, setFilterScore, onSearch, onExport, loading, hasProspects }) {
            return (
                <div style={styles.controls}>
                    <button 
                        style={styles.btnPrimary} 
                        onClick={onSearch}
                        disabled={loading}
                    >
                        {loading ? 'üîç Searching...' : 'üöÄ Search for Prospects'}
                    </button>
                    <input
                        type="text"
                        style={styles.input}
                        value={searchCity}
                        onChange={(e) => setSearchCity(e.target.value)}
                        placeholder="City or State (e.g., Dallas, Texas, Arizona)"
                    />
                    <select 
                        style={styles.select}
                        value={filterScore}
                        onChange={(e) => setFilterScore(e.target.value)}
                    >
                        <option value="all">All Scores</option>
                        <option value="90+">90+ (Urgent)</option>
                        <option value="80-89">80-89 (High)</option>
                    </select>
                    {hasProspects && (
                        <button style={styles.btn} onClick={onExport}>
                            üì• Export CSV
                        </button>
                    )}
                </div>
            );
        }

        function SearchStatus({ message }) {
            return (
                <div style={styles.searchStatus}>
                    <p>{message}</p>
                </div>
            );
        }

        function Loading() {
            return (
                <div style={styles.loading}>
                    <div style={styles.loadingText}>Processing...</div>
                </div>
            );
        }

        function ProspectsList({ prospects, onGenerateEmail, onDelete }) {
            if (prospects.length === 0) {
                return (
                    <div style={styles.empty}>
                        <h2 style={styles.emptyTitle}>No prospects yet</h2>
                        <p style={styles.emptyText}>Click "Search for Prospects" to find BTR developers using AI</p>
                        <p style={styles.emptySubtext}>The AI will search the web for active BTR developers, executives, and project details</p>
                    </div>
                );
            }

            return (
                <div style={styles.grid}>
                    {prospects.map((prospect) => (
                        <ProspectCard 
                            key={prospect.id} 
                            prospect={prospect}
                            onGenerateEmail={onGenerateEmail}
                            onDelete={onDelete}
                        />
                    ))}
                </div>
            );
        }

        function ProspectCard({ prospect, onGenerateEmail, onDelete }) {
            return (
                <div style={styles.card}>
                    <div style={styles.cardHeader}>
                        <div>
                            <h3 style={styles.companyName}>{prospect.company}</h3>
                            <p style={styles.location}>{prospect.city}, {prospect.state}</p>
                        </div>
                        <div style={styles.scoreBadge}>{prospect.score}</div>
                    </div>
                    <div style={styles.executive}>
                        <strong>{prospect.executive || 'Contact via company'}</strong> {prospect.title && `- ${prospect.title}`}
                        {prospect.linkedin && (
                            <a 
                                href={`https://${prospect.linkedin}`} 
                                target="_blank"
                                style={styles.linkedinLink}
                            >
                                üîó LinkedIn
                            </a>
                        )}
                    </div>
                    <div style={styles.details}>
                        <div><strong>Project:</strong> {prospect.projectName}</div>
                        <div><strong>Status:</strong> {prospect.projectStatus}</div>
                        <div><strong>Size:</strong> {prospect.units}</div>
                        <div><strong>TIV:</strong> {prospect.tiv}</div>
                    </div>
                    <div style={styles.whyNow}>
                        <strong>üî• Why Call NOW:</strong>
                        <p>{prospect.whyNow}</p>
                    </div>
                    {prospect.signals && prospect.signals.length > 0 && (
                        <div style={styles.signals}>
                            <strong>‚ö° Signals:</strong>
                            <ul style={styles.signalList}>
                                {prospect.signals.map((signal, idx) => (
                                    <li key={idx} style={styles.signalItem}>‚ñ∏ {signal}</li>
                                ))}
                            </ul>
                        </div>
                    )}
                    <div style={styles.cardActions}>
                        <button 
                            style={styles.emailBtn}
                            onClick={() => onGenerateEmail(prospect)}
                        >
                            ‚úâÔ∏è Generate Email
                        </button>
                        <button 
                            style={styles.deleteBtn}
                            onClick={() => onDelete(prospect.id)}
                        >
                            üóëÔ∏è
                        </button>
                    </div>
                </div>
            );
        }

        function EmailModal({ email, prospect, onClose }) {
            const copyEmail = () => {
                navigator.clipboard.writeText(email);
                alert('Email copied to clipboard!');
            };

            return (
                <div style={styles.modalOverlay} onClick={onClose}>
                    <div style={styles.modal} onClick={(e) => e.stopPropagation()}>
                        <div style={styles.modalHeader}>
                            <h2>Generated Email for {prospect.company}</h2>
                            <button style={styles.closeBtn} onClick={onClose}>‚úï</button>
                        </div>
                        <pre style={styles.emailText}>{email}</pre>
                        <div style={styles.modalActions}>
                            <button style={styles.btnPrimary} onClick={copyEmail}>
                                üìã Copy Email
                            </button>
                            <button style={styles.btn} onClick={onClose}>Close</button>
                        </div>
                    </div>
                </div>
            );
        }

        const styles = {
            container: { maxWidth: '1400px', margin: '0 auto', padding: '2rem' },
            header: { marginBottom: '3rem', textAlign: 'center' },
            title: { fontFamily: 'Orbitron, sans-serif', fontSize: '3rem', fontWeight: 900, background: 'linear-gradient(135deg, #00ff88 0%, #00d4ff 100%)', WebkitBackgroundClip: 'text', WebkitTextFillColor: 'transparent', marginBottom: '0.5rem' },
            subtitle: { fontSize: '1.1rem', color: '#8b95ab' },
            statsBar: { display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(200px, 1fr))', gap: '1.5rem', marginBottom: '3rem' },
            statCard: { background: '#151b2e', border: '1px solid #1f2937', borderRadius: '12px', padding: '1.5rem' },
            statLabel: { fontSize: '0.85rem', color: '#8b95ab', textTransform: 'uppercase', marginBottom: '0.5rem' },
            statValue: { fontFamily: 'Orbitron, sans-serif', fontSize: '2rem', fontWeight: 700, color: '#00ff88', lineHeight: '1.2', display: 'block', minHeight: '2.4rem' },
            pulse: { animation: 'pulse 2s ease-in-out infinite' },
            controls: { display: 'flex', gap: '1rem', marginBottom: '2rem', flexWrap: 'wrap' },
            btn: { background: '#151b2e', border: '1px solid #1f2937', color: '#e8eef7', padding: '0.75rem 1.5rem', borderRadius: '8px', fontSize: '0.9rem', cursor: 'pointer' },
            btnPrimary: { background: '#00ff88', border: 'none', color: '#0a0e1a', padding: '0.75rem 1.5rem', borderRadius: '8px', fontSize: '0.9rem', fontWeight: 600, cursor: 'pointer' },
            input: { background: '#151b2e', border: '1px solid #1f2937', color: '#e8eef7', padding: '0.75rem 1rem', borderRadius: '8px', fontSize: '0.9rem', minWidth: '250px' },
            select: { background: '#151b2e', border: '1px solid #1f2937', color: '#e8eef7', padding: '0.75rem 1rem', borderRadius: '8px', fontSize: '0.9rem', cursor: 'pointer' },
            searchStatus: { background: 'rgba(0, 255, 136, 0.1)', border: '1px solid #00ff88', borderRadius: '8px', padding: '1rem', marginBottom: '2rem', textAlign: 'center', fontWeight: 600 },
            loading: { textAlign: 'center', padding: '3rem' },
            loadingText: { fontFamily: 'Orbitron, sans-serif', fontSize: '1.2rem', color: '#00ff88', animation: 'pulse 1.5s ease-in-out infinite' },
            empty: { textAlign: 'center', padding: '4rem' },
            emptyTitle: { fontSize: '2rem', marginBottom: '1rem', color: '#8b95ab' },
            emptyText: { fontSize: '1.1rem', color: '#8b95ab', marginBottom: '0.5rem' },
            emptySubtext: { fontSize: '0.9rem', color: '#6b7589' },
            grid: { display: 'grid', gap: '1.5rem' },
            card: { background: '#151b2e', border: '1px solid #1f2937', borderRadius: '12px', padding: '1.5rem' },
            cardHeader: { display: 'flex', justifyContent: 'space-between', marginBottom: '1rem' },
            companyName: { fontFamily: 'Orbitron, sans-serif', fontSize: '1.3rem', fontWeight: 700, marginBottom: '0.25rem' },
            location: { color: '#8b95ab', fontSize: '0.9rem' },
            scoreBadge: { background: 'linear-gradient(135deg, #00ff88, #00d4ff)', color: '#0a0e1a', padding: '0.5rem 1rem', borderRadius: '20px', fontFamily: 'Orbitron, sans-serif', fontWeight: 700, fontSize: '1.1rem' },
            executive: { marginBottom: '1rem', paddingBottom: '1rem', borderBottom: '1px solid #1f2937' },
            linkedinLink: { marginLeft: '1rem', color: '#00d4ff', textDecoration: 'none', fontSize: '0.9rem' },
            details: { display: 'grid', gridTemplateColumns: 'repeat(2, 1fr)', gap: '0.5rem', marginBottom: '1rem', fontSize: '0.9rem' },
            whyNow: { background: 'rgba(255, 71, 87, 0.1)', border: '1px solid #ff4757', borderRadius: '8px', padding: '1rem', marginBottom: '1rem' },
            signals: { background: 'rgba(0, 212, 255, 0.05)', border: '1px solid rgba(0, 212, 255, 0.2)', borderRadius: '8px', padding: '1rem', marginBottom: '1rem' },
            signalList: { listStyle: 'none', marginTop: '0.5rem' },
            signalItem: { marginBottom: '0.5rem' },
            cardActions: { display: 'flex', gap: '0.5rem' },
            emailBtn: { flex: 1, background: '#00ff88', border: 'none', color: '#0a0e1a', padding: '0.75rem', borderRadius: '8px', fontWeight: 600, cursor: 'pointer', fontSize: '1rem' },
            deleteBtn: { background: '#ff4757', border: 'none', color: '#fff', padding: '0.75rem 1rem', borderRadius: '8px', cursor: 'pointer', fontSize: '1rem' },
            modalOverlay: { position: 'fixed', top: 0, left: 0, right: 0, bottom: 0, background: 'rgba(0, 0, 0, 0.8)', display: 'flex', alignItems: 'center', justifyContent: 'center', zIndex: 1000 },
            modal: { background: '#151b2e', border: '1px solid #1f2937', borderRadius: '12px', padding: '2rem', maxWidth: '600px', width: '90%', maxHeight: '80vh', overflow: 'auto' },
            modalHeader: { display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '1rem' },
            closeBtn: { background: 'none', border: 'none', color: '#e8eef7', fontSize: '1.5rem', cursor: 'pointer' },
            emailText: { background: '#0a0e1a', padding: '1.5rem', borderRadius: '8px', whiteSpace: 'pre-wrap', fontFamily: 'JetBrains Mono, monospace', fontSize: '0.9rem', lineHeight: '1.6', marginBottom: '1rem' },
            modalActions: { display: 'flex', gap: '1rem' }
        };

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>
